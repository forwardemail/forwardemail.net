# البريد الإلكتروني المقاوم للكم: كيف نستخدم صناديق بريد SQLite المشفرة للحفاظ على أمان بريدك الإلكتروني {#quantum-resistant-email-how-we-use-encrypted-sqlite-mailboxes-to-keep-your-email-safe}

<img loading="lazy" src="/img/articles/quantum.webp" alt="" class="rounded-lg" />

## جدول المحتويات {#table-of-contents}

* [مقدمة](#foreword)
* [مقارنة مزودي خدمة البريد الإلكتروني](#email-service-provider-comparison)
* [كيف يعمل؟](#how-does-it-work)
* [التقنيات](#technologies)
  * [قواعد البيانات](#databases)
  * [حماية](#security)
  * [صناديق البريد](#mailboxes)
  * [التزامن](#concurrency)
  * [النسخ الاحتياطية](#backups)
  * [يبحث](#search)
  * [المشاريع](#projects)
  * [مقدمي الخدمات](#providers)
* [أفكار](#thoughts)
  * [مبادئ](#principles)
  * [التجارب](#experiments)
  * [عدم وجود بدائل](#lack-of-alternatives)
  * [جرب إعادة توجيه البريد الإلكتروني](#try-out-forward-email)

## مقدمة {#foreword}

خدمة البريد الإلكتروني لدينا > \[!IMPORTANT]
> خدمة البريد الإلكتروني لدينا [مفتوح المصدر بنسبة 100%](https://github.com/forwardemail)، وهي تركز على الخصوصية من خلال صناديق بريد SQLite آمنة ومشفرة.

حتى أطلقنا [دعم IMAP](/faq#do-you-support-receiving-email-with-imap)، كنا نستخدم MongoDB لتلبية احتياجاتنا المتعلقة بتخزين البيانات المستمرة.

هذه التكنولوجيا مذهلة وما زلنا نستخدمها حتى يومنا هذا - ولكن من أجل الحصول على تشفير ثابت مع MongoDB، تحتاج إلى استخدام مزود يقدم MongoDB Enterprise، مثل Digital Ocean أو Mongo Atlas - أو دفع ثمن ترخيص مؤسسي (وبعد ذلك يتعين عليك العمل مع زمن انتقال فريق المبيعات).

احتاج فريقنا في [إعادة توجيه البريد الإلكتروني](https://forwardemail.net) إلى حل تخزين سهل الاستخدام، وقابل للتطوير، وموثوق، ومشفّر لصناديق بريد IMAP. وبصفتنا مطورين مفتوحي المصدر، فإن استخدام تقنية تتطلب دفع رسوم ترخيص للحصول على ميزة التشفير عند السكون كان يتعارض مع [مبادئنا](#principles)، ولذلك أجرينا تجارب وأبحاثًا وطوّرنا حلاً جديدًا من الصفر لتلبية هذه الاحتياجات.

بدلاً من استخدام قاعدة بيانات مشتركة لتخزين صناديق بريدك، نقوم بتخزينها وتشفيرها بشكل فردي باستخدام كلمة مرورك (التي تملكها أنت وحدك). **خدمة البريد الإلكتروني لدينا آمنة للغاية، فإذا نسيت كلمة مرورك، ستفقد صندوق بريدك** (وستحتاج إلى استعادته باستخدام نسخ احتياطية غير متصلة بالإنترنت أو البدء من جديد).

واصل القراءة بينما نستعرض بالتفصيل أدناه [مقارنة بين مزودي خدمات البريد الإلكتروني](#email-service-provider-comparison)، و[كيف تعمل خدمتنا](#how-does-it-work)، و[مجموعة التكنولوجيا لدينا](#technologies)، والمزيد.

## مقارنة مزودي خدمة البريد الإلكتروني {#email-service-provider-comparison}

نحن مزود خدمة البريد الإلكتروني الوحيد مفتوح المصدر بنسبة 100% والذي يركز على الخصوصية والذي يخزن صناديق بريد SQLite المشفرة بشكل فردي، ويقدم نطاقات وأسماء مستعارة ومستخدمين غير محدودة، ويدعم SMTP وIMAP وPOP3 الصادر:

**على عكس مزودي خدمات البريد الإلكتروني الآخرين، لن تحتاج إلى دفع رسوم تخزين لكل نطاق أو اسم مستعار مع خدمة "إعادة توجيه البريد الإلكتروني".** مساحة التخزين مشتركة على حسابك بالكامل، لذا إذا كان لديك عدة أسماء نطاقات مخصصة وأسماء مستعارة متعددة على كل منها، فنحن الحل الأمثل لك. يُرجى العلم أنه لا يزال بإمكانك فرض حدود تخزين لكل نطاق أو اسم مستعار، إذا رغبت في ذلك.

<a href="/blog/best-email-service" target="_blank" class="btn btn-lg bg-success text-white btn-block btn-success">اقرأ مقارنة خدمات البريد الإلكتروني <i class="fa fa-search-plus"></i></a>

## كيف يعمل؟ {#how-does-it-work}

1. باستخدام عميل البريد الإلكتروني الخاص بك مثل Apple Mail أو Betterbird أو Gmail أو Outlook - يمكنك الاتصال بخوادم [IMAP](/faq#do-you-support-receiving-email-with-imap) الآمنة لدينا باستخدام اسم المستخدم وكلمة المرور الخاصة بك:

* اسم المستخدم هو اسمك المستعار الكامل مع نطاقك مثل `hello@example.com`.
* يتم توليد كلمة مرورك عشوائيًا، ولا تظهر لك إلا لمدة 30 ثانية عند النقر على <strong class="text-success"><i class="fa fa-key"></i>إنشاء كلمة مرور</strong> من <a href="/my-account/domains" target="_blank" rel="noopener noreferrer" class="alert-link">حسابي <i class="fa fa-angle-right"></i>النطاقات</a> <i class="fa fa-angle-right"></i>الأسماء المستعارة.

٢. بمجرد الاتصال، سيرسل برنامج البريد الإلكتروني الخاص بك [أوامر بروتوكول IMAP](https://en.wikipedia.org/wiki/Internet_Message_Access_Protocol) إلى خادم IMAP الخاص بنا للحفاظ على مزامنة صندوق بريدك. يشمل ذلك كتابة مسودات رسائل البريد الإلكتروني وتخزينها، بالإضافة إلى إجراءات أخرى قد تقوم بها (مثل تصنيف رسالة بريد إلكتروني كمهمة أو وضع علامة على أنها بريد عشوائي).

٣. تستقبل خوادم تبادل البريد (المعروفة عادةً بخوادم "MX") رسائل البريد الإلكتروني الواردة الجديدة وتخزنها في صندوق بريدك. عند حدوث ذلك، سيتلقى برنامج البريد الإلكتروني إشعارًا وسيزامن صندوق بريدك. تستطيع خوادم تبادل البريد لدينا إعادة توجيه بريدك الإلكتروني إلى مستلم واحد أو أكثر (بما في ذلك [خطافات الويب](/faq#do-you-support-webhooks))، أو تخزينه في وحدة تخزين IMAP المشفرة لدينا، **أو كليهما**!

> \[!TIP]
> هل ترغب بمعرفة المزيد؟ اقرأ [كيفية إعداد إعادة توجيه البريد الإلكتروني](/faq#how-do-i-get-started-and-set-up-email-forwarding)، [كيف تعمل خدمة تبادل البريد لدينا](/faq#how-does-your-email-forwarding-system-work)، أو اطلع على [مرشدينا](/guides).

4. خلف الكواليس، يعمل تصميم تخزين البريد الإلكتروني الآمن لدينا بطريقتين للحفاظ على صناديق البريد الخاصة بك مشفرة ولا يمكن الوصول إليها إلا من قبلك:

* عند استلام بريد جديد لك من مرسل، تقوم خوادم تبادل البريد لدينا بالكتابة إلى صندوق بريد فردي مؤقت ومشفر لك.

     ```mermaid
     sequenceDiagram
         autonumber
         actor Sender
         Sender->>MX: Inbound message received for your alias (e.g. you@yourdomain.com).
         MX->>SQLite: Message is stored in a temporary mailbox.
         Note over MX,SQLite: Forwards to other recipients and webhooks configured.
         MX->>Sender: Success!
     ```

* عند اتصالك بخادم IMAP الخاص بنا باستخدام برنامج البريد الإلكتروني، تُشفَّر كلمة مرورك في الذاكرة وتُستخدم لقراءة رسائلك وكتابتها في صندوق بريدك. لا يُمكن قراءة رسائلك وكتابتها إلا باستخدام كلمة المرور هذه. تذكر أنه بما أنك الوحيد الذي يملك كلمة المرور هذه، **أنت فقط** من يمكنه قراءة رسائلك وكتابتها في صندوق بريدك عند الوصول إليه. في المرة القادمة التي يحاول فيها برنامج البريد الإلكتروني البحث عن رسائل أو مزامنتها، سيتم نقل رسائلك الجديدة من صندوق البريد المؤقت هذا وتخزينها في ملف صندوق بريدك الفعلي باستخدام كلمة المرور التي أدخلتها. يُرجى العلم أنه سيتم مسح صندوق البريد المؤقت هذا وحذفه لاحقًا، بحيث لا يحتوي على الرسائل إلا صندوق بريدك المحمي بكلمة مرور.

* **إذا كنت متصلاً ببروتوكول IMAP (مثلاً باستخدام برنامج بريد إلكتروني مثل Apple Mail أو Betterbird)، فلن نحتاج إلى الكتابة إلى وحدة تخزين مؤقتة على القرص. بدلاً من ذلك، سيتم جلب كلمة مرور IMAP المشفرة المحفوظة في الذاكرة واستخدامها. في الوقت الفعلي، عند محاولة تسليم رسالة إليك، نرسل طلب WebSocket إلى جميع خوادم IMAP نسألهم عما إذا كانت لديهم جلسة نشطة لك (هذه هي مرحلة الجلب)، ثم نمرر كلمة المرور المشفرة المحفوظة في الذاكرة - لذا لا نحتاج إلى الكتابة إلى صندوق بريد مؤقت، بل يمكننا الكتابة إلى صندوق بريدك المشفر الفعلي باستخدام كلمة مرورك المشفرة.**

     ```mermaid
     sequenceDiagram
         autonumber
         actor You
         You->>IMAP: You connect to IMAP server using an email client.
         IMAP->>SQLite: Transfer message from temporary mailbox to your alias' mailbox.
         Note over IMAP,SQLite: Your alias' mailbox is only available in-memory using IMAP password.
         SQLite->>IMAP: Retrieves messages as requested by email client.
         IMAP->>You: Success!
     ```

٥. يتم إنشاء [نسخ احتياطية لصناديق البريد المشفرة الخاصة بك](#backups) يوميًا. يمكنك أيضًا طلب نسخة احتياطية جديدة في أي وقت أو تنزيل أحدث نسخة احتياطية من <a href="/my-account/domains" target="_blank" rel="noopener noreferrer" class="alert-link">حسابي <i class="fa fa-angle-right"></i> النطاقات</a> <i class="fa fa-angle-right"></i> الأسماء المستعارة. إذا قررت الانتقال إلى خدمة بريد إلكتروني أخرى، يمكنك بسهولة نقل وتنزيل وتصدير وحذف صناديق بريدك والنسخ الاحتياطية في أي وقت.

## التقنيات {#technologies}

### قواعد بيانات {#databases}

لقد استكشفنا طبقات تخزين قاعدة البيانات الأخرى المحتملة، ولكن لم تلبي أي منها متطلباتنا بقدر ما فعلت SQLite:

| قاعدة البيانات | التشفير في حالة السكون | صناديق البريد | رخصة | [Used Everywhere](https://www.sqlite.org/mostdeployed.html) |
| ------------------------------------------------------ | :-----------------------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------: | :---------------------------------------------------------: | :---------------------------------------------------------: |
| **__رابط الخلية_0__** :star: | :white_check_mark: نعم مع [SQLite3MultipleCiphers](https://github.com/utelle/SQLite3MultipleCiphers) | :علامة_التحقق_البيضاء: | :white_check_mark: المجال العام | :علامة_التحقق_البيضاء: |
| [MongoDB](https://www.mongodb.com/) | :x: __رابط الخلية_0__ | :x: قاعدة بيانات علائقية | :x: AGPL و `SSPL-1.0` | :x: |
| [rqlite](https://github.com/rqlite/rqlite) | :x: __رابط الخلية_0__ | :x: قاعدة بيانات علائقية | :علامة_التحقق_البيضاء: __رمز_الخلية_0__ | :x: |
| [dqlite](https://dqlite.io/) | :x: __رابط الخلية_0__ | :x: __رابط الخلية_0__ | :علامة_التحقق_البيضاء: __رمز_الخلية_0__ | :x: |
| [PostgreSQL](https://www.postgresql.org/) | :علامة_التحقق_البيضاء: __رابط_الخلية_0__ | :x: قاعدة بيانات علائقية | :white_check_mark: `PostgreSQL` (مشابه لـ `BSD` أو `MIT`) | :x: |
| [MariaDB](https://mariadb.com/) | :علامة_التحقق_البيضاء: __رابط_الخلية_0__ | :x: قاعدة بيانات علائقية | :white_check_mark: `GPLv2` و `BUSL-1.1` | :x: |
| [CockroachDB](https://www.cockroachlabs.com/product/) | :x: __رابط الخلية_0__ | :x: قاعدة بيانات علائقية | :x: `BUSL-1.1` وآخرون | :x: |

> فيما يلي [تدوينة تقارن بين عدة خيارات لتخزين قاعدة بيانات SQLite](https://gcore.com/learning/comparing-litestream-rqlite-dqlite/) في الجدول أعلاه.

### الأمان {#security}

نستخدم دائمًا تشفير [التشفير في حالة السكون](https://en.wikipedia.org/wiki/Data_at_rest) ([AES-256](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard))، و[التشفير أثناء النقل](https://en.wikipedia.org/wiki/Data_in_transit) ([TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security))، و[DNS عبر HTTPS](https://en.wikipedia.org/wiki/DNS_over_HTTPS) ("DoH") باستخدام :tangerine: [اليوسفي](https://tangeri.ne)، و[سكليت](https://utelle.github.io/SQLite3MultipleCiphers/docs/ciphers/cipher_chacha20/) ([تشاتشا20-بولي1305](https://utelle.github.io/SQLite3MultipleCiphers/docs/ciphers/cipher_chacha20/)) على صناديق البريد. بالإضافة إلى ذلك، نستخدم مصادقة ثنائية العوامل قائمة على الرمز (على عكس الرسائل النصية القصيرة التي يُشتبه في أنها [هجمات الرجل في المنتصف](https://en.wikipedia.org/wiki/Man-in-the-middle_attack))، ومفاتيح SSH مُدارة مع تعطيل الوصول إلى الجذر، ووصول حصري إلى الخوادم عبر عناوين IP مقيدة، وغيرها.

في حال وجود حامل بريد مؤقت ([هجوم الخادمة الشريرة](https://en.wikipedia.org/wiki/Evil_maid_attack)) أو موظف غير موثوق من جهة خارجية، **لا يزال بإمكانك فتح صندوق بريدك الإلكتروني إلا باستخدام كلمة المرور المُولّدة**. كن مطمئنًا، لا نعتمد على أي جهات خارجية أخرى سوى مزودي خوادمنا الحاصلين على شهادة SOC من النوع 2، وهم Cloudflare وDataPacket وDigital Ocean وVultr.

هدفنا هو الحصول على أقل عدد ممكن من [نقطة فشل واحدة](https://en.wikipedia.org/wiki/Single_point_of_failure).

### صناديق البريد {#mailboxes}

> **tldr;** تستخدم خوادم IMAP الخاصة بنا قواعد بيانات SQLite مشفرة بشكل فردي لكل صندوق بريد لديك.

قاعدة البيانات المضمنة [SQLite هو برنامج شائع للغاية](https://www.sqlite.org/mostdeployed.html) - يتم تشغيلها حاليًا على هاتفك والكمبيوتر - [وتستخدمها جميع التقنيات الرئيسية تقريبًا](https://www.sqlite.org/famous.html).

على سبيل المثال، يوجد على خوادمنا المشفرة صندوق بريد قاعدة بيانات SQLite لـ `linux@example.com`، و`info@example.com`، و`hello@example.com`، وهكذا - لكل منها ملف قاعدة بيانات `.sqlite`. لا نسمي ملفات قاعدة البيانات بعنوان البريد الإلكتروني، بل نستخدم معرف كائن BSON ومعرفات UUID فريدة مُولّدة، والتي لا تُشارك اسم صاحب صندوق البريد أو عنوان البريد الإلكتروني الذي يتبعه (مثل `353a03f21e534321f5d6e267.sqlite`).

كل قاعدة بيانات من هذه القواعد مُشفّرة ذاتيًا باستخدام كلمة مرورك (التي تملكها وحدك) باستخدام [سكليت](https://utelle.github.io/SQLite3MultipleCiphers/docs/ciphers/cipher_chacha20/) ([تشاتشا20-بولي1305](https://utelle.github.io/SQLite3MultipleCiphers/docs/ciphers/cipher_chacha20/)). هذا يعني أن صناديق بريدك مُشفّرة بشكل فردي، ومستقلّة، وقابلة للنقل.

لقد قمنا بضبط SQLite باستخدام [PRAGMA](https://www.sqlite.org/pragma.html) التالي:

| `PRAGMA` | غاية |
| ------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `cipher=chacha20` | [ChaCha20-Poly1305 SQLite database encryption](https://utelle.github.io/SQLite3MultipleCiphers/docs/ciphers/cipher_chacha20/). راجع `better-sqlite3-multiple-ciphers` ضمن [Projects](#projects) لمزيد من المعلومات. |
| `key="****************"` | هذه كلمة مرورك المُفككة والمُخزّنة في الذاكرة فقط، والتي تُمرّر عبر اتصال IMAP لعميل البريد الإلكتروني الخاص بك إلى خادمنا. يتم إنشاء نسخ جديدة من قاعدة البيانات وإغلاقها لكل جلسة قراءة وكتابة (لضمان الحماية والعزل). |
| `journal_model=WAL` | سجل الكتابة المسبقة ("[WAL](https://www.sqlite.org/wal.html)") [which boosts performance and allows concurrent read access](https://litestream.io/tips/#wal-journal-mode). |
| `busy_timeout=5000` | يمنع أخطاء قفل الكتابة [while other writes are taking place](https://litestream.io/tips/#busy-timeout). |
| `synchronous=NORMAL` | يزيد من متانة المعاملات [without data corruption risk](https://litestream.io/tips/#synchronous-pragma). |
| `foreign_keys=ON` | ينفذ فرض مراجع المفاتيح الخارجية (على سبيل المثال علاقة من جدول إلى آخر). [By default this is not turned on in SQLite](https://www.sqlite.org/foreignkeys.html)، ولكن للتحقق من صحة البيانات وسلامتها يجب تمكينه. |
| `encoding='UTF-8'` | [Default encoding](https://www.sqlite.org/pragma.html#pragma_encoding) لاستخدامه لضمان سلامة المطور. |

>جميع الإعدادات الافتراضية الأخرى هي من SQLite كما هو محدد من [وثائق PRAGMA الرسمية](https://www.sqlite.org/pragma.html#pragma_auto_vacuum).

### التزامن {#concurrency}

> **tldr;** نستخدم `WebSocket` للقراءة والكتابة المتزامنة إلى صناديق بريد SQLite المشفرة الخاصة بك.

#### يقرأ {#reads}

قد يقوم عميل البريد الإلكتروني على هاتفك بحل `imap.forwardemail.net` إلى أحد عناوين IP الخاصة بـ Digital Ocean - وقد يقوم عميل سطح المكتب الخاص بك بحل عنوان IP منفصل من [مزود](#providers) مختلف تمامًا.

بغض النظر عن خادم IMAP الذي يتصل به عميل البريد الإلكتروني الخاص بك، نريد أن يقرأ الاتصال من قاعدة بياناتك في الوقت الفعلي بدقة 100%. يتم ذلك من خلال WebSockets.

#### يكتب {#writes}

تختلف عملية الكتابة إلى قاعدة البيانات الخاصة بك بعض الشيء - نظرًا لأن SQLite عبارة عن قاعدة بيانات مضمنة وصندوق البريد الخاص بك موجود في ملف واحد بشكل افتراضي.

لقد استكشفنا خيارات مثل `litestream`، و`rqlite`، و`dqlite` أدناه - ولكن لم يلبِّ أي منها متطلباتنا.

لإتمام عمليات الكتابة مع تفعيل خاصية التسجيل المسبق ("[WAL](https://www.sqlite.org/wal.html)")، يجب التأكد من أن خادمًا واحدًا فقط ("Primary") مسؤول عن ذلك. يُسرّع [WAL](https://www.sqlite.org/wal.html) عملية التزامن بشكل كبير، ويسمح بكاتب واحد وقراء متعددين.

يعمل الخادم الأساسي على خوادم البيانات التي تحتوي على وحدات التخزين المُركّبة التي تحتوي على صناديق البريد المُشفّرة. من منظور التوزيع، يُمكن اعتبار جميع خوادم IMAP المُستقلة خلف `imap.forwardemail.net` خوادم ثانوية ("ثانوية").

نحن ننجز الاتصال ثنائي الاتجاه باستخدام [مآخذ الويب](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket):

* تستخدم الخوادم الأساسية مثيلًا من خادم [ويس](https://github.com/websockets/ws) `WebSocketServer`.

* تستخدم الخوادم الثانوية مثيلًا من عميل [ويس](https://github.com/websockets/ws) `WebSocket`، المُغلَّف بـ [مقبس الويب كما وعد](https://github.com/vitalets/websocket-as-promised) و[إعادة توصيل مقبس الويب](https://github.com/opensumi/reconnecting-websocket). يضمن هذان التغليفان إعادة اتصال `WebSocket`، وقدرته على إرسال واستقبال البيانات لعمليات كتابة محددة في قاعدة البيانات.

### نسخ احتياطية {#backups}

> **ملخص:** يتم إجراء نسخ احتياطية لصناديق بريدك المشفرة يوميًا. يمكنك أيضًا طلب نسخة احتياطية جديدة فورًا أو تنزيل أحدث نسخة احتياطية في أي وقت من <a href="/my-account/domains" target="_blank" rel="noopener noreferrer" class="alert-link">حسابي <i class="fa fa-angle-right"></i> النطاقات</a> <i class="fa fa-angle-right"></i> الأسماء المستعارة.

للنسخ الاحتياطية، نقوم ببساطة بتشغيل أمر SQLite `VACUUM INTO` يوميًا أثناء معالجة أوامر IMAP، مما يستغل كلمة مرورك المشفرة من اتصال IMAP في الذاكرة. تُخزَّن النسخ الاحتياطية في حال عدم اكتشاف أي نسخة احتياطية موجودة، أو في حال تغير قيمة تجزئة [SHA-256](https://en.wikipedia.org/wiki/SHA-2) في الملف مقارنةً بأحدث نسخة احتياطية.

لاحظ أننا نستخدم الأمر `VACUUM INTO` بدلاً من الأمر `backup` المدمج، لأنه في حال تعديل صفحة أثناء استخدام الأمر `backup`، يجب إعادة تشغيلها. سيأخذ الأمر `VACUUM INTO` لقطة. راجع هذه التعليقات على [جيثب](https://github.com/benbjohnson/litestream.io/issues/56) و[أخبار القراصنة](https://news.ycombinator.com/item?id=31387556) لمزيد من المعلومات.

بالإضافة إلى ذلك، نستخدم `VACUUM INTO` بدلاً من `backup`، لأن الأمر `backup` سيترك قاعدة البيانات غير مشفرة لفترة وجيزة حتى يتم استدعاء `rekey` (انظر GitHub [تعليق](https://github.com/m4heshd/better-sqlite3-multiple-ciphers/issues/46#issuecomment-1468018927) للحصول على مزيد من المعلومات).

سيقوم الجهاز الثانوي بإرسال التعليمات للجهاز الأساسي عبر اتصال `WebSocket` لتنفيذ النسخ الاحتياطي - ثم سيستقبل الجهاز الأساسي الأمر للقيام بذلك وسوف يقوم بعد ذلك بما يلي:

١. اتصل بصندوق بريدك المشفر.
٢. احصل على قفل الكتابة.
٣. شغّل نقطة تفتيش WAL عبر `wal_checkpoint(PASSIVE)`.
٤. شغّل أمر SQLite `VACUUM INTO`.
٥. تأكد من إمكانية فتح الملف المنسوخ باستخدام كلمة المرور المشفرة (الحماية/الحماية الوهمية).
٦. حمّله إلى Cloudflare R2 للتخزين (أو إلى مزوّد خدمة التخزين الخاص بك إذا تم تحديده).

<!--
٧. اضغط ملف النسخ الاحتياطي الناتج باستخدام `gzip`.
٨. حمّله إلى Cloudflare R2 للتخزين (أو إلى مزوّد خدمة خاص بك إن وجد).
-->

تذكر أن صناديق البريد الخاصة بك مشفرة - وعلى الرغم من وجود قيود IP وتدابير مصادقة أخرى مطبقة لاتصالات WebSocket - في حالة وجود جهة سيئة، يمكنك التأكد من أنه ما لم يكن حمولة WebSocket تحتوي على كلمة مرور IMAP الخاصة بك، فلن تتمكن من فتح قاعدة البيانات الخاصة بك.

يتم تخزين نسخة احتياطية واحدة فقط لكل صندوق بريد في الوقت الحالي، ولكن في المستقبل قد نقدم استردادًا في نقطة زمنية معينة ("[PITR](https://en.wikipedia.org/wiki/Point-in-time_recovery)").

### بحث {#search}

تدعم خوادم IMAP الخاصة بنا الأمر `SEARCH` مع الاستعلامات المعقدة وتعبيرات عادية والمزيد.

يتم تحقيق أداء بحث سريع بفضل [FTS5](https://www.sqlite.org/fts5.html) و[sqlite-regex](https://github.com/asg017/sqlite-regex#sqlite-regex).

نقوم بتخزين قيم `Date` في صناديق بريد SQLite كسلاسل [ISO 8601](https://en.wikipedia.org/wiki/ISO\_8601) عبر [Date.prototype.toISOString](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/toISOString) (مع المنطقة الزمنية UTC لمقارنات المساواة لتعمل بشكل صحيح).

يتم أيضًا تخزين الفهارس لجميع الخصائص الموجودة في استعلامات البحث.

### مشاريع {#projects}

فيما يلي جدول يوضح المشاريع التي نستخدمها في الكود المصدر وعملية التطوير (مرتبة أبجديًا):

| مشروع | غاية |
| --------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [Ansible](https://www.ansible.com/) | منصة أتمتة DevOps لصيانة وتوسيع وإدارة أسطولنا بالكامل من الخوادم بكل سهولة. |
| [Bree](https://github.com/breejs/bree) | مجدول الوظائف لـ Node.js وJavaScript مع cron، والتواريخ، والملي ثانية، واللاحقة، والدعم السهل الاستخدام. |
| [Cabin](https://github.com/cabinjs/cabin) | مكتبة تسجيل JavaScript وNode.js صديقة للمطورين مع وضع الأمان والخصوصية في الاعتبار. |
| [Lad](https://github.com/ladjs/lad) | إطار عمل Node.js الذي يدعم بنيتنا الكاملة وتصميمنا الهندسي باستخدام MVC والمزيد. |
| [MongoDB](https://www.mongodb.com/) | حل قاعدة بيانات NoSQL الذي نستخدمه لتخزين جميع البيانات الأخرى خارج صناديق البريد (على سبيل المثال حسابك والإعدادات والمجالات وتكوينات الأسماء المستعارة). |
| [Mongoose](https://github.com/Automattic/mongoose) | نمذجة مستندات كائنات MongoDB ("ODM") التي نستخدمها في جميع حزمنا. كتبنا أدوات مساعدة خاصة تُمكّننا من مواصلة استخدام **Mongoose مع SQLite** بسهولة. |
| [Node.js](https://nodejs.org/en) | Node.js هي بيئة تشغيل JavaScript مفتوحة المصدر ومتعددة الأنظمة الأساسية والتي تقوم بتشغيل جميع عمليات الخادم لدينا. |
| [Nodemailer](https://github.com/nodemailer/nodemailer) | حزمة Node.js لإرسال رسائل البريد الإلكتروني، وإنشاء الاتصالات، والمزيد. نحن الراعي الرسمي لهذا المشروع. |
| [Redis](https://redis.io/) | قاعدة بيانات في الذاكرة للتخزين المؤقت وقنوات النشر/الاشتراك وطلبات DNS عبر HTTPS. |
| [SQLite3MultipleCiphers](https://github.com/utelle/SQLite3MultipleCiphers) | امتداد التشفير لـ SQLite للسماح بتشفير ملفات قاعدة البيانات بأكملها (بما في ذلك سجل الكتابة المسبقة ("[WAL](https://www.sqlite.org/wal.html)")، والمجلة، والتراجع، ...). |
| [SQLiteStudio](https://github.com/pawelsalawa/sqlitestudio) | محرر Visual SQLite (الذي يمكنك استخدامه أيضًا) لاختبار صناديق البريد الخاصة بالتطوير وتنزيلها وعرضها. |
| [SQLite](https://www.sqlite.org/about.html) | طبقة قاعدة بيانات مضمنة لتخزين IMAP قابل للتطوير ومستقل وسريع ومرن. |
| [Spam Scanner](https://github.com/spamscanner/spamscanner) | أداة Node.js لمكافحة البريد العشوائي وتصفية البريد الإلكتروني ومنع التصيد الاحتيالي (بديلنا لـ [Spam Assassin](https://spamassassin.apache.org/) و [rspamd](https://github.com/rspamd/rspamd)). |
| [Tangerine](https://tangeri.ne) | طلبات DNS عبر HTTPS باستخدام Node.js والتخزين المؤقت باستخدام Redis - مما يضمن الاتساق العالمي وأكثر من ذلك بكثير. |
| [Betterbird](https://betterbird.eu/) | يستخدم فريق التطوير الخاص بنا هذا (ويوصي به أيضًا) باعتباره **عميل البريد الإلكتروني المفضل للاستخدام مع إعادة توجيه البريد الإلكتروني**. |
| [UTM](https://github.com/utmapp/UTM) | يستخدم فريق التطوير الخاص بنا هذه الآلات الافتراضية لإنشاء أنظمة التشغيل iOS وmacOS لاختبار عملاء البريد الإلكتروني المختلفين (بالتوازي) مع خوادم IMAP وSMTP الخاصة بنا. |
| [Ubuntu](https://ubuntu.com/download/server) | نظام تشغيل خادم حديث مفتوح المصدر يعتمد على Linux والذي يدعم كافة البنية التحتية لدينا. |
| [WildDuck](https://github.com/nodemailer/wildduck) | مكتبة خادم IMAP - راجع ملاحظاتها على [attachment de-duplication](https://github.com/nodemailer/wildduck/blob/master/docs/in-depth/attachment-deduplication.md) و [IMAP protocol support](https://github.com/nodemailer/wildduck/blob/master/docs/in-depth/protocol-support.md). |
| [better-sqlite3-multiple-ciphers](https://github.com/m4heshd/better-sqlite3-multiple-ciphers) | مكتبة API سريعة وبسيطة لـ Node.js للتفاعل مع SQLite3 برمجيًا. |
| [email-templates](https://github.com/forwardemail/email-templates) | إطار عمل بريد إلكتروني صديق للمطورين لإنشاء رسائل بريد إلكتروني مخصصة ومعاينتها وإرسالها (على سبيل المثال إشعارات الحساب والمزيد). |
| [json-sql-enhanced](https://github.com/forwardemail/json-sql-enhanced) | منشئ استعلامات SQL باستخدام صيغة Mongo. هذا يوفر وقت فريق التطوير لدينا، إذ يمكننا الاستمرار في الكتابة بصيغة Mongo عبر كامل الحزمة، مع نهج مستقل عن قواعد البيانات. **كما أنه يساعد على تجنب هجمات حقن SQL باستخدام معلمات الاستعلام.** |
| [knex-schema-inspector](https://github.com/knex/knex-schema-inspector) | أداة SQL لاستخراج معلومات حول مخطط قاعدة البيانات الحالي. هذا يُمكّننا من التحقق بسهولة من صحة جميع الفهارس والجداول والأعمدة والقيود وغيرها، وأنها `1:1` كما ينبغي. حتى أننا طوّرنا أدوات مساعدة آلية لإضافة أعمدة وفهرس جديدة في حال إجراء تغييرات على مخططات قاعدة البيانات (مع تنبيهات أخطاء مفصلة للغاية). |
| [knex](https://github.com/knex/knex) | منشئ استعلامات SQL الذي نستخدمه فقط لترحيل قواعد البيانات والتحقق من صحة المخطط من خلال `knex-schema-inspector`. |
| [mandarin](https://github.com/ladjs/mandarin) | ترجمة العبارة التلقائية [i18n](https://en.wikipedia.org/wiki/Internationalization_and_localization) مع دعم Markdown باستخدام [Google Cloud Translation API](https://cloud.google.com/translate/docs/reference/rest). |
| [mx-connect](https://github.com/zone-eu/mx-connect) | حزمة Node.js لحل وإنشاء اتصالات مع خوادم MX ومعالجة الأخطاء. |
| [pm2](https://github.com/Unitech/pm2) | مدير عملية إنتاج Node.js مع موازن التحميل المدمج ([fine-tuned](https://github.com/Unitech/pm2/issues/5145#issuecomment-1737764214) للأداء). |
| [smtp-server](https://github.com/nodemailer/smtp-server) | مكتبة خادم SMTP – نستخدمها لتبادل البريد الإلكتروني ("MX") وخوادم SMTP الصادرة. |
| [ImapTest](https://www.imapwiki.org/ImapTest) | أداة مفيدة لاختبار خوادم IMAP وفقًا لمعايير وتوافق بروتوكول IMAP مع مواصفات RFC. أنشأ هذا المشروع فريق [Dovecot](https://en.wikipedia.org/wiki/Dovecot_\(software\) (خادم IMAP وPOP3 مفتوح المصدر نشط منذ يوليو 2002). اختبرنا خادم IMAP الخاص بنا على نطاق واسع باستخدام هذه الأداة. |

>يمكنك العثور على المشاريع الأخرى التي نستخدمها في [كود المصدر الخاص بنا على GitHub](https://github.com/forwardemail).

### مقدمو الخدمة {#providers}

| مزود | غاية |
| ----------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| [Cloudflare](https://www.cloudflare.com/) | مزود DNS، وفحوصات الصحة، وموازنات التحميل، وتخزين النسخ الاحتياطية باستخدام [Cloudflare R2](https://developers.cloudflare.com/r2). |
| [Digital Ocean](https://m.do.co/c/a7fe489d1b27) | استضافة خادم مخصص وقواعد بيانات مُدارة. |
| [Vultr](https://www.vultr.com/?ref=7429848) | استضافة خادم مخصص. |
| [DataPacket](https://www.datapacket.com) | استضافة خادم مخصص. |

## أفكار {#thoughts}

### مبادئ {#principles}

تم تصميم خدمة إعادة توجيه البريد الإلكتروني وفقًا للمبادئ التالية:

١. كن دائمًا صديقًا للمطورين، مع التركيز على الأمان والخصوصية، وشفافًا.

٢. التزم بـ [MVC](https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller)، و[يونكس](https://en.wikipedia.org/wiki/Unix_philosophy)، و[KISS](https://en.wikipedia.org/wiki/KISS_principle)، و[DRY](https://en.wikipedia.org/wiki/Don%27t_repeat_yourself)، و[YAGNI](https://en.wikipedia.org/wiki/You_aren%27t_gonna_need_it)، و[اثني عشر عاملًا](https://12factor.net/)، و[شفرة أوكام](https://en.wikipedia.org/wiki/Occam%27s_razor)، و[طعام الكلاب](https://en.wikipedia.org/wiki/Eating_your_own_dog_food).

٣. استهدف المطورين الذين يعتمدون على التطوير الذاتي، والذين يستخدمون [مربحة من الرامن](http://www.paulgraham.com/ramenprofitable.html).

### تجارب {#experiments}

في النهاية، لا يعد استخدام تخزين الكائنات المتوافق مع S3 و/أو الجداول الافتراضية ممكنًا من الناحية الفنية لأسباب تتعلق بالأداء وعرضة للخطأ بسبب قيود الذاكرة.

لقد أجرينا بعض التجارب التي أدت إلى حل SQLite النهائي كما ناقشنا أعلاه.

كان أحد هذه الحلول هو محاولة استخدام [rclone]() وSQLite مع طبقة تخزين متوافقة مع S3.

قادتنا هذه التجربة إلى فهم واكتشاف الحالات الحدية المحيطة باستخدام rclone وSQLite و[VFS](https://en.wikipedia.org/wiki/Virtual_file_system) بشكل أكبر:

* إذا فعّلتَ علامة `--vfs-cache-mode writes` باستخدام rclone، فستكون عمليات القراءة سليمة، ولكن سيتم تخزين عمليات الكتابة مؤقتًا.
* إذا كان لديك عدة خوادم IMAP موزعة عالميًا، فسيتم إيقاف تشغيل التخزين المؤقت عبرها إلا إذا كان لديك كاتب واحد ومستمعون متعددون (مثل نهج النشر/الاشتراك).
* هذا الأمر معقد للغاية، وإضافة أي تعقيد إضافي كهذا سيؤدي إلى المزيد من نقاط الفشل الفردية.
* لا يدعم موفرو التخزين المتوافقون مع S3 التغييرات الجزئية للملفات - مما يعني أن أي تغيير في ملف `.sqlite` سيؤدي إلى تغيير كامل وإعادة تحميل قاعدة البيانات.
* توجد حلول أخرى مثل `rsync`، لكنها لا تركز على دعم سجل الكتابة المسبقة ("[WAL](https://www.sqlite.org/wal.html)") - لذلك انتهينا من مراجعة Litestream. لحسن الحظ، يُشفّر استخدامنا للتشفير ملفات [WAL](https://www.sqlite.org/wal.html) بالفعل، لذا لا نحتاج إلى الاعتماد على Litestream لذلك. مع ذلك، لم نكن واثقين بعد من استخدام Litestream للاستخدام الإنتاجي، ولدينا بعض الملاحظات أدناه حول ذلك.

* سيؤدي استخدام خيار `--vfs-cache-mode writes` (الطريقة *الوحيدة* لاستخدام SQLite بدلاً من `rclone` للكتابة) إلى محاولة نسخ قاعدة البيانات بأكملها من البداية إلى الذاكرة - التعامل مع صندوق بريد واحد بسعة 10 جيجابايت أمرٌ مقبول، ولكن التعامل مع صناديق بريد متعددة ذات سعة تخزين عالية جدًا سيؤدي إلى مواجهة خوادم IMAP قيودًا في الذاكرة وأخطاء `ENOMEM`، وأخطاء في التجزئة، وتلف البيانات.

* إذا حاولت استخدام SQLite [الطاولات الافتراضية](https://www.sqlite.org/vtab.html) (مثل استخدام [s3db](https://github.com/jrhy/s3db)) لحفظ البيانات على طبقة تخزين متوافقة مع S3، فستواجه العديد من المشاكل الأخرى:

* ستكون عمليات القراءة والكتابة بطيئة للغاية، حيث ستحتاج نقاط نهاية واجهة برمجة تطبيقات S3 إلى الوصول إلى HTTP `.sqlite`0 و`.sqlite`1 و`.sqlite`2 و`.sqlite`3.

* أظهرت اختبارات التطوير أن تجاوز عدد السجلات من 500 ألف إلى مليون سجل على شبكة الإنترنت عبر الألياف الضوئية لا يزال محدودًا بمعدل نقل البيانات والكتابة إلى موفري خدمات متوافقين مع S3. على سبيل المثال، شغّل مطورونا حلقات `.sqlite`4 لتنفيذ عبارات SQL `.sqlite`5 المتسلسلة، وتلك التي تكتب كميات كبيرة من البيانات بشكل جماعي. في كلتا الحالتين، كان الأداء بطيئًا بشكل مذهل. * الجداول الافتراضية **لا يمكن أن تحتوي على فهارس**، وعبارات `.sqlite`6، و`.sqlite`7 و`.sqlite`8 - مما يؤدي إلى تأخيرات تصل إلى دقيقة أو دقيقتين أو أكثر حسب كمية البيانات.
* تم تخزين الكائنات بدون تشفير، ولا يتوفر دعم تشفير أصلي بسهولة.
* استكشفنا أيضًا استخدام `.sqlite`9، وهو مشابه مفاهيميًا وتقنيًا للنقطة السابقة (لذا فهو يعاني من نفس المشاكل). أحد الاحتمالات هو استخدام بنية `rsync`0 مخصصة مشفّرة مثل `rsync`1 (الذي نستخدمه حاليًا في حلنا أعلاه) من خلال `rsync`2.
* نهج آخر محتمل هو استخدام `rsync`3، ولكن هذا له حد أقصى قدره 32 جيجابايت، وسيتطلب تعقيدات في البناء والتطوير.
* عبارات `rsync`4 مطلوبة (لذا، هذا يستبعد تمامًا استخدام الجداول الافتراضية). نحتاج إلى عبارات `rsync`5 لكي يعمل ربطنا مع `rsync`6 بشكل صحيح، مما يضمن عدم تلف البيانات وإمكانية تحويل الصفوف المسترجعة إلى مستندات صالحة وفقًا لتعريفات مخطط `rsync`7 (التي تتضمن القيد، ونوع المتغير، والتحقق من صحة البيانات بشكل عشوائي).
* جميع المشاريع المتوافقة مع S3 تقريبًا والمتعلقة بـ SQLite في مجتمع المصادر المفتوحة تعمل بلغة بايثون (وليس جافا سكريبت التي نستخدمها بنسبة 100% في مجموعتنا).
* تبدو مكتبات الضغط مثل `rsync`8 (انظر `rsync`9) واعدة، ولكن __PROTECTED_LINK_189__0. بدلاً من ذلك، يُعدّ الضغط من جانب التطبيق على أنواع البيانات مثل __PROTECTED_LINK_189__1 و__PROTECTED_LINK_189__2 و__PROTECTED_LINK_189__3 و__PROTECTED_LINK_189__4 و__PROTECTED_LINK_189__5 و__PROTECTED_LINK_189__6 نهجًا أنظف وأسهل (وأسهل في النقل أيضًا، حيث يُمكننا تخزين علامة أو عمود __PROTECTED_LINK_189__7 - أو حتى استخدام __PROTECTED_LINK_189__8 و__PROTECTED_LINK_189__9 للضغط أو __PROTECTED_LINK_190__0 لعدم الضغط كبيانات تعريفية لقاعدة البيانات).

* لحسن الحظ، لدينا بالفعل خاصية إزالة تكرار المرفقات في وحدة تخزين خادم IMAP لدينا - وبالتالي، لن تحتفظ كل رسالة تحتوي على نفس المرفق بنسخة منه - بل يُخزّن مرفق واحد لرسائل وسلاسل رسائل متعددة في صندوق بريد (ويُستخدم مرجع خارجي لاحقًا).

* مشروع Litestream، وهو حل نسخ احتياطي ونسخ احتياطي لـ SQLite، واعد جدًا، ومن المرجح أن نستخدمه في المستقبل.
* لا نريد التقليل من شأن المؤلفين - فنحن نعشق عملهم ومساهماتهم في مجال المصادر المفتوحة منذ أكثر من عقد - ولكن من خلال الاستخدام العملي، يبدو أن هناك __PROTECTED_LINK_190__1 و__PROTECTED_LINK_190__2.
* يجب أن تكون استعادة النسخة الاحتياطية سلسة وسهلة. استخدام حل مثل MongoDB مع __PROTECTED_LINK_190__3 و__PROTECTED_LINK_190__4 ليس مملًا فحسب، بل يتطلب وقتًا طويلًا وتعقيدًا في التكوين.
* قواعد بيانات SQLite تجعل الأمر بسيطًا (إنه ملف واحد).
* أردنا تصميم حل يسمح للمستخدمين بأخذ صندوق بريدهم ومغادرته في أي وقت.
* أوامر Node.js بسيطة إلى __PROTECTED_LINK_190__5، ويتم مسحه نهائيًا من وحدة تخزين القرص.
* يمكننا أيضًا استخدام واجهة برمجة تطبيقات متوافقة مع S3 مع HTTP __PROTECTED_LINK_190__6 لإزالة اللقطات والنسخ الاحتياطية بسهولة للمستخدمين.
* كان SQLite الحل الأبسط والأسرع والأقل تكلفة.

### عدم وجود بدائل {#lack-of-alternatives}

على حد علمنا، لا توجد خدمات بريد إلكتروني أخرى مصممة بهذه الطريقة ولا تعد مفتوحة المصدر.

نعتقد أن هذا قد يكون بسبب خدمات البريد الإلكتروني الحالية التي تحتوي على تقنية قديمة في الإنتاج مع [كود السباغيتي](https://en.wikipedia.org/wiki/Spaghetti_code) :spaghetti:.

معظم، إن لم يكن كل، موفري خدمات البريد الإلكتروني الحاليين إما مغلقي المصدر أو يعلنون عن كونهم مفتوحي المصدر، **ولكن في الواقع فإن واجهتهم الأمامية فقط هي مفتوحة المصدر.**

**الجزء الأكثر حساسية في البريد الإلكتروني** (التفاعل الفعلي بين التخزين/IMAP/SMTP) **يتم إجراؤه بالكامل على الواجهة الخلفية (الخادم)، وليس على الواجهة الأمامية (العميل)**.

### جرب إعادة توجيه البريد الإلكتروني {#try-out-forward-email}

سجل اليوم في <https://forwardemail.net>! :rocket: