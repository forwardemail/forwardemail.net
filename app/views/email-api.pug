//- Pug makes it DOCTYPE if we do this:
//- `doctype html`
!= "<!doctype html>"
- const isNotPrivateRoute = ["/my-account", "/admin", "/verify", "/denylist", "/forgot-password", "/reset-password", "/help", "/auth", "/register", config.loginOtpRoute, config.loginRoute, config.verifyRoute, config.otpRoutePrefix].every((s) => !ctx.pathWithoutLocale.startsWith(s));
html.h-100.no-js(
  lang=locale,
  class=isBot(ctx.get("User-Agent")) ? "bot-detected" : "",
  dir=["ar", "he"].includes(locale) ? "rtl" : false
)
  head
    block meta
      include _meta
    block opengraph
      include _opengraph
    block fonts
      include _fonts
    block stylesheets
      style.
        :root {
          --scalar-font: "Nunito Sans", "Helvetica Neue", Arial, sans-serif;
          --scalar-font-code: Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

      link(
        rel="stylesheet",
        href=manifest("css/app.css"),
        integrity=manifest("css/app.css", "integrity"),
        fetchpriority="high",
        crossorigin="anonymous"
      )
  body(role="document")
    include _nav
    .scalar-app-reset
      #app
    include _footer

    //- scripts (mirrored from layout.pug block scripts)
    if !isBot(ctx.get('User-Agent'))
      //- flash messaging (with koa-better-flash and sweetalert2)
      script(defer, nonce=nonce).
        window._types = {
          success: "#{ t('Success') }",
          error: "#{ t('Error') }",
          info: "#{ t('Info') }",
          warning: "#{ t('Warning') }",
          question: "#{ t('Question') }",
        };
      //- prettier-ignore
      script#flash-messages(defer, nonce=nonce, data-ignore-hash-change).
        window._messages = !{json(flash(), null, null)};
      //- set defaults for sweetalert2
      //- <https://github.com/limonte/sweetalert2/issues/763>
      script(defer, nonce=nonce).
        window._swalDefaults = {
          confirmButtonText: "#{ t('OK') }",
          cancelButtonText: "#{ t('Cancel') }",
          closeButtonAriaLabel: "#{ t('Close this dialog') }",
          reverseButtons: true,
        };

      //- set defaults for confirm prompt sweetalert2 modal
      script(defer, nonce=nonce).
        window._confirmPromptTitle = "#{ t('Are you sure?') }";
        window._confirmPromptHTML = "#{ t('Please confirm if you wish to continue.') }";

      //- set the locale to be used by front-end assets
      script(defer, nonce=nonce).
        window.LOCALE = "#{locale}";

      //- set the API endpoint to be used by front-end assets
      script(defer, nonce=nonce).
        window.API_URL = "#{config.urls.api}";

    //- set the user and API key to be used by CabinJS
    if config.env !== 'test' && !isBot(ctx.get('User-Agent'))
      if user
        script(defer, nonce=nonce).
          window.USER = {
            id: "#{user.id}",
            name: "#{user[config.passport.fields.displayName]}",
            email: "#{user.email}",
          };
          window.API_TOKEN = "#{user[config.userFields.apiToken]}";
      else if ctx.sessionId
        script(defer, nonce=nonce).
          window.USER = {
            id: "#{ctx.sessionId}",
          };

    if !isBot(ctx.get('User-Agent'))
      //- build
      script(
        defer,
        src=manifest("js/build.js"),
        integrity=manifest("js/build.js", "integrity"),
        crossorigin="anonymous",
        fetchpriority="low"
      )

      //- cloudflare turnstile (hidden from bots and admins)
      if config.turnstileEnabled && (!user || user.group !== 'admin')
        script(defer, nonce=nonce).
          window.TURNSTILE_RENDER_ERROR = "#{ t('Turnstile render error, please try again or contact us.') }";
          window.TURNSTILE_SITE_KEY = "#{ config.turnstileSiteKey }";
        script(
          defer,
          src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onloadTurnstileCallback"
        )

    //- scalar API reference
    script(src="/js/scalar.js", crossorigin="anonymous")
    if user
      script.
        window.API_TOKEN = "#{user[config.userFields.apiToken]}";
    - const API_SPEC = `${config.urls.web}/api-spec${locale === "en" ? "" : "-" + locale}.json`;
    script.
      window.API_URL = "#{config.urls.api}";
      window.WEB_URL = "#{config.urls.web}";
      window.OG_IMAGE = "#{ogImage}";
      window.SITE_NAME = "#{config.appName}";
      window.TITLE = "#{meta.title}";
      window.DESCRIPTION = "#{meta.description}";

      Scalar.createApiReference("#app", {
        withDefaultFonts: false,
        servers: [
          {
            url: window.API_URL,
          },
        ],
        url: "#{API_SPEC}",
        authentication: {
          preferredSecurityScheme: "ApiKeyAuth",
          securitySchemes: {
            ApiKeyAuth: {
              username: window.API_TOKEN || "",
              password: "",
            },
            AliasAuth: {
              name: "Authorization",
              in: "header",
              value: window.API_TOKEN || "",
            },
          },
        },
        favicon: "/img/favicon.svg",
        metaData: {
          title: window.TITLE,
          ogTitle: window.TITLE,
          description: window.DESCRIPTION,
          ogDescription: window.DESCRIPTION,
          ogImage: window.OG_IMAGE,
          siteName: window.SITE_NAME,
        },
        hideClientButton: true,
      });

    include _wikipedia
