extends ../../layout

block body
  .container-fluid.py-3
    .row.mt-1
      .col
        include ../../_breadcrumbs
        
        //- Debug info
        script.
          console.log('Page loaded, inquiry ID:', '#{inquiry.id}');
        
        //- Add data attribute for inquiry ID
        div(data-inquiry-id=inquiry.id)
        
        //- Inquiry Header
        .card.mb-3
          .card-header
            .row.align-items-center
              .col
                h4.mb-0
                  i.fa.fa-envelope.mr-2
                  = t("Inquiry Details")
              .col-auto
                a.btn.btn-outline-primary.btn-sm(href="/admin/inquiries")
                  i.fa.fa-arrow-left.mr-1
                  = t("Back to Inquiries")
          
          .card-body
            .row
              .col-md-3
                strong= t("Created:")
                br
                = inquiry.created_at
              .col-md-3
                strong= t("User:")
                br
                if inquiry.user && inquiry.user.email
                  = inquiry.user.email
                else
                  span.text-muted= t("Unknown")
              .col-md-3
                strong= t("Status:")
                br
                - const status = inquiry.status || 'new'
                .d-flex.align-items-center
                  case status
                    when 'new'
                      span.badge.badge-primary.mr-2= t("New")
                    when 'in_progress'
                      span.badge.badge-warning.mr-2= t("In Progress")
                    when 'resolved'
                      span.badge.badge-success.mr-2= t("Resolved")
                    when 'closed'
                      span.badge.badge-secondary.mr-2= t("Closed")
                    default
                      span.badge.badge-light.mr-2= t("Unknown")
                  
                  //- Status Update Form
                  .dropdown
                    button.btn.btn-sm.btn-outline-secondary.dropdown-toggle(
                      type="button",
                      data-toggle="dropdown",
                      aria-haspopup="true",
                      aria-expanded="false",
                      title="Change Status"
                    )
                      i.fa.fa-edit
                    .dropdown-menu
                      form.ajax-form.confirm-prompt(
                        action=`${ctx.path}/status`,
                        method="POST"
                      )
                        input(type="hidden", name="_method", value="PUT")
                        input(type="hidden", name="status", value="new")
                        button.dropdown-item(type="submit", class=status === 'new' ? 'active' : '')
                          span.badge.badge-primary.mr-2= t("New")
                          = t("New")
                      form.ajax-form.confirm-prompt(
                        action=`${ctx.path}/status`,
                        method="POST"
                      )
                        input(type="hidden", name="_method", value="PUT")
                        input(type="hidden", name="status", value="in_progress")
                        button.dropdown-item(type="submit", class=status === 'in_progress' ? 'active' : '')
                          span.badge.badge-warning.mr-2= t("In Progress")
                          = t("In Progress")
                      form.ajax-form.confirm-prompt(
                        action=`${ctx.path}/status`,
                        method="POST"
                      )
                        input(type="hidden", name="_method", value="PUT")
                        input(type="hidden", name="status", value="resolved")
                        button.dropdown-item(type="submit", class=status === 'resolved' ? 'active' : '')
                          span.badge.badge-success.mr-2= t("Resolved")
                          = t("Resolved")
                      form.ajax-form.confirm-prompt(
                        action=`${ctx.path}/status`,
                        method="POST"
                      )
                        input(type="hidden", name="_method", value="PUT")
                        input(type="hidden", name="status", value="closed")
                        button.dropdown-item(type="submit", class=status === 'closed' ? 'active' : '')
                          span.badge.badge-secondary.mr-2= t("Closed")
                          = t("Closed")
              .col-md-3
                strong= t("Priority:")
                br
                - const priority = inquiry.priority || 'medium'
                .d-flex.align-items-center
                  case priority
                    when 'high'
                      span.badge.badge-danger.mr-2= t("High")
                    when 'medium'
                      span.badge.badge-warning.mr-2= t("Medium")
                    when 'low'
                      span.badge.badge-success.mr-2= t("Low")
                    default
                      span.badge.badge-secondary.mr-2= t("Medium")
                  
                  //- Priority Update Form
                  .dropdown
                    button.btn.btn-sm.btn-outline-secondary.dropdown-toggle(
                      type="button",
                      data-toggle="dropdown",
                      aria-haspopup="true",
                      aria-expanded="false",
                      title="Change Priority"
                    )
                      i.fa.fa-edit
                    .dropdown-menu
                      form.ajax-form.confirm-prompt(
                        action=`${ctx.path}/priority`,
                        method="POST"
                      )
                        input(type="hidden", name="_method", value="PUT")
                        input(type="hidden", name="priority", value="high")
                        button.dropdown-item(type="submit", class=priority === 'high' ? 'active' : '')
                          span.badge.badge-danger.mr-2= t("High")
                          = t("High")
                      form.ajax-form.confirm-prompt(
                        action=`${ctx.path}/priority`,
                        method="POST"
                      )
                        input(type="hidden", name="_method", value="PUT")
                        input(type="hidden", name="priority", value="medium")
                        button.dropdown-item(type="submit", class=priority === 'medium' ? 'active' : '')
                          span.badge.badge-warning.mr-2= t("Medium")
                          = t("Medium")
                      form.ajax-form.confirm-prompt(
                        action=`${ctx.path}/priority`,
                        method="POST"
                      )
                        input(type="hidden", name="_method", value="PUT")
                        input(type="hidden", name="priority", value="low")
                        button.dropdown-item(type="submit", class=priority === 'low' ? 'active' : '')
                          span.badge.badge-success.mr-2= t("Low")
                          = t("Low")
        
        //- Messages Display - Email Thread Style
        .card.mb-3
          .card-header.bg-white.border-bottom
            .d-flex.align-items-center.justify-content-between
              h5.mb-0
                i.fa.fa-comments.mr-2.text-primary
                = t("Conversation History")
              .text-muted.small
                if messages && messages.length > 0
                  = `${messages.length} ${messages.length === 1 ? t("message") : t("messages")}`
          
          .card-body.p-0
            if messages && messages.length > 0
              .conversation-thread
                each message, index in messages
                  - const isSupport = message.type === 'support' || message.from === 'Support' || message.from === 'Support Team'
                  - const isLastMessage = index === messages.length - 1
                  
                  .message-item(
                    class=isSupport ? 'support-message' : 'customer-message',
                    class=isLastMessage ? 'last-message' : ''
                  )
                    .message-header
                      .d-flex.align-items-center
                        .avatar-container
                          if isSupport
                            .avatar.support-avatar
                              i.fa.fa-headset
                          else
                            .avatar.customer-avatar
                              i.fa.fa-user
                        .message-meta.flex-grow-1
                          .sender-name
                            if message.from
                              = message.from
                            else if inquiry.user && inquiry.user.email
                              = inquiry.user.email
                            else
                              = t("Unknown Sender")
                          .message-time
                            if message.date
                              = message.date
                            else
                              = inquiry.created_at
                    
                    .message-content
                      if message.html
                        != message.html
                      else if message.text
                        pre.message-text= message.text
                      else if message.message
                        pre.message-text= message.message
                      else
                        pre.message-text= inquiry.message || t("No message content")
            else
              .empty-state
                .text-center.py-5
                  .empty-icon
                    i.fa.fa-inbox.fa-3x.text-muted
                  h6.mt-3.text-muted= t("No messages found")
                  p.text-muted.small= t("This inquiry doesn't have any messages yet")
        
        //- Reply Form - Enhanced Email Composer
        .card.reply-card
          .card-header.bg-white.border-bottom
            .d-flex.align-items-center.justify-content-between
              h5.mb-0
                i.fa.fa-reply.mr-2.text-primary
                = t("Send Reply")
              .reply-status
                #save-indicator.text-muted.small
                  i.fa.fa-circle-o-notch.fa-spin.mr-1(style="display: none;")
                  span Auto-saving...
          
          form.confirm-prompt(
            action=ctx.path,
            method="POST",
            enctype="multipart/form-data"
          )
            .card-body
              .form-group
                .composer-header.mb-3
                  .row.align-items-center
                    .col
                      label.font-weight-bold(for="inquiry-response-editor")= t("Your Response")
                    .col-auto
                      .editor-actions
                        button.btn.btn-outline-primary.btn-sm(
                          type="button",
                          onclick="showPreview()",
                          title="Preview"
                        )
                          i.fa.fa-eye.mr-1
                          = t("Preview")
                
                
                //- CodeMirror Editor Container
                .editor-container
                  textarea#inquiry-response-editor.form-control(
                    name="message",
                    rows="12",
                    required,
                    placeholder="Write your response here... You can use Markdown formatting."
                  )
                
                //- Editor Footer
                .editor-footer.mt-2
                  .row.align-items-center
                    .col
                      #character-count.text-muted.small 0 characters, 0 words
                    .col-auto
                      .text-muted.small
                        i.fa.fa-info-circle.mr-1
                        = t("Supports Markdown formatting")
              
              .form-group
                label.font-weight-bold(for="input-attachments")
                  i.fa.fa-paperclip.mr-1
                  = t("Attachments")
                .custom-file
                  input#input-attachments.custom-file-input(
                    type="file",
                    name="attachments",
                    multiple
                  )
                  label.custom-file-label(for="input-attachments")= t("Choose files...")
            
            .card-footer.bg-light
              .row.align-items-center
                .col-md-6
                  small.text-muted
                    i.fa.fa-save.mr-1
                    = t("Drafts are automatically saved")
                .col-md-6.text-right
                  button.btn.btn-outline-secondary.mr-2(
                    type="button",
                    onclick="history.back()"
                  )
                    i.fa.fa-arrow-left.mr-1
                    = t("Back")
                  button.btn.btn-primary(
                    type="submit"
                  )
                    i.fa.fa-paper-plane.mr-1
                    = t("Send Reply")

//- Asset loading
block append scripts
  script(
    defer,
    src=manifest("js/inquiries.js"),
    integrity=manifest("js/inquiries.js", "integrity"),
    crossorigin="anonymous"
  )

block append stylesheets
  link(
    rel="stylesheet",
    href=manifest("css/codemirror.css"),
    integrity=manifest("css/codemirror.css", "integrity"),
    crossorigin="anonymous"
  )