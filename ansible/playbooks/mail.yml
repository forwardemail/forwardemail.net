# Copyright (c) Forward Email LLC
# SPDX-License-Identifier: BUSL-1.1

---
# SnappyMail Mail Deployment
# Reuses existing security, certificates, and HTTP infrastructure

- name: Import security playbook
  import_playbook: security.yml
- name: Import SSH keys playbook
  import_playbook: ssh-keys.yml

- hosts: mail
  name: Mail Hostname
  become: true
  become_user: root
  tasks:
    - name: Set hostname
      hostname:
        name: "{{ lookup('env', 'MAIL_HOST') }}"

- hosts: mail
  name: SnappyMail PHP-FPM Setup
  become: true
  become_user: root
  handlers:
    - name: Restart PHP-FPM
      service:
        name: php8.2-fpm
        state: restarted
  tasks:
    - name: Add PHP repository
      apt_repository:
        repo: ppa:ondrej/php
        state: present
        update_cache: true

    - name: Install PHP and extensions
      apt:
        name:
          - php8.2-fpm
          - php8.2-cli
          - php8.2-common
          - php8.2-intl
          - php8.2-zip
          - php8.2-gd
          - php8.2-dom
          - php8.2-xml
          - php8.2-curl
          - php8.2-mbstring
          - php8.2-opcache
          - php8.2-redis
        state: present
        update_cache: true

    - name: Verify PHP curl extension is loaded in CLI
      command: php -m
      register: php_cli_modules
      changed_when: false

    - name: Display PHP CLI modules (curl check)
      debug:
        msg: "PHP CLI has curl: {{ 'YES' if 'curl' in php_cli_modules.stdout else 'NO - WILL INSTALL' }}"

    - name: Ensure php-curl is installed
      apt:
        name: php8.2-curl
        state: present
      notify: Restart PHP-FPM

    - name: Verify curl extension file exists
      stat:
        path: /etc/php/8.2/mods-available/curl.ini
      register: curl_ini

    - name: Display curl extension status
      debug:
        msg: "curl.ini exists: {{ curl_ini.stat.exists }}"

    - name: Create PHP-FPM log directory
      file:
        path: /var/log/php-fpm
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Ensure SnappyMail cache directory exists
      file:
        path: /dev/shm/snappymail-cache
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Configure PHP-FPM pool
      template:
        src: "{{ playbook_dir }}/templates/snappymail/php-fpm-www.conf.j2"
        dest: /etc/php/8.2/fpm/pool.d/www.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart PHP-FPM

    - name: Configure PHP FPM settings
      template:
        src: "{{ playbook_dir }}/templates/snappymail/php-fpm.ini.j2"
        dest: /etc/php/8.2/fpm/conf.d/99-snappymail.ini
        owner: root
        group: root
        mode: '0644'
      notify: Restart PHP-FPM

    - name: Enable PHP-FPM service
      systemd:
        name: php8.2-fpm
        enabled: true
        state: started

    - name: Configure PHP-FPM logrotate
      copy:
        content: |
          /var/log/php-fpm/*.log {
              daily
              missingok
              rotate 14
              compress
              delaycompress
              notifempty
              create 0640 www-data www-data
              sharedscripts
              postrotate
                  [ -f /run/php/php8.2-fpm.pid ] && kill -USR1 $(cat /run/php/php8.2-fpm.pid)
              endscript
          }
        dest: /etc/logrotate.d/php-fpm
        mode: '0644'

- hosts: mail
  name: SnappyMail Nginx Setup
  become: true
  become_user: root
  handlers:
    - name: Reload Nginx
      service:
        name: nginx
        state: reloaded
  tasks:
    - name: Install Nginx
      apt:
        name:
          - nginx
          - nginx-extras
        state: present
        update_cache: true

    - name: Remove default Nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload Nginx

    - name: Configure main Nginx config
      template:
        src: "{{ playbook_dir }}/templates/snappymail/nginx.conf.j2"
        dest: /etc/nginx/nginx.conf
        owner: root
        group: root
        mode: '0644'
      notify: Reload Nginx

    - name: Enable Nginx service
      systemd:
        name: nginx
        enabled: true
        state: started

- hosts: mail
  name: SnappyMail Application Deployment
  become: true
  become_user: root
  handlers:
    - name: Reload UFW
      ufw:
        state: reloaded
    - name: Reload Nginx
      service:
        name: nginx
        state: reloaded
    - name: Restart fail2ban
      service:
        name: fail2ban
        state: restarted
  tasks:
    ##
    # Firewall Configuration
    ##

    - name: Enable ufw
      ufw:
        state: enabled
        policy: deny
        direction: incoming

    - name: Limit ufw ssh
      ufw:
        rule: limit
        port: 22
        proto: tcp

    - name: Allow ssh
      ufw:
        rule: allow
        port: 22
        proto: tcp

    - name: Allow http
      ufw:
        rule: allow
        port: "{{ lookup('env', 'MAIL_PROXY_PORT') }}"
        proto: tcp

    - name: Allow https
      ufw:
        rule: allow
        port: "{{ lookup('env', 'MAIL_HTTP_PORT') }}"
        proto: tcp

    - name: Install fail2ban
      apt:
        name: fail2ban
        state: present
        update_cache: true

    - name: Deploy fail2ban filter for SnappyMail
      template:
        src: "{{ playbook_dir }}/templates/snappymail/fail2ban-snappymail-auth.conf.j2"
        dest: /etc/fail2ban/filter.d/snappymail-auth.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Configure fail2ban jail for SnappyMail
      template:
        src: "{{ playbook_dir }}/templates/snappymail/fail2ban-snappymail-auth.local.j2"
        dest: /etc/fail2ban/jail.d/snappymail-auth.local
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Ensure fail2ban service is enabled
      systemd:
        name: fail2ban
        enabled: true
        state: started

    - name: "Update ufw before.rules until #21 is resolved"
      template:
        src: "{{ playbook_dir }}/templates/before.rules.j2"
        dest: /etc/ufw/before.rules
        owner: root
        mode: "0644"
      notify: Reload UFW

    ##
    # Application Directory Setup
    ##

    - name: Create application directory
      file:
        path: /var/www/snappymail
        state: directory
        owner: deploy
        group: deploy
        mode: '0755'

    ##
    # Deploy Application
    ##

    - name: Check if repository exists
      stat:
        path: /var/www/snappymail/.git
      register: git_repo

    - name: Clone repository
      git:
        repo: "{{ lookup('env', 'MAIL_REPO') }}"
        dest: /var/www/snappymail
        version: "{{ lookup('env', 'MAIL_GIT_BRANCH') | default('main', true) }}"
        force: true
      become_user: deploy
      when: not git_repo.stat.exists

    - name: Update repository
      git:
        repo: "{{ lookup('env', 'MAIL_REPO') }}"
        dest: /var/www/snappymail
        version: "{{ lookup('env', 'MAIL_GIT_BRANCH') | default('main', true) }}"
        force: true
        update: true
      become_user: deploy
      when: git_repo.stat.exists

    - name: Initialize submodules
      command: git submodule update --init --recursive
      args:
        chdir: /var/www/snappymail
      become_user: deploy

    ##
    # Build SnappyMail
    ##

    - name: Install required build tools
      apt:
        name:
          - curl
          - gnupg
          - ca-certificates
        state: present
        update_cache: true

    - name: Add NodeSource GPG key
      apt_key:
        url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
        state: present

    - name: Add NodeSource repository for Node.js 20.x
      apt_repository:
        repo: "deb https://deb.nodesource.com/node_20.x nodistro main"
        state: present
        filename: nodesource

    - name: Install Node.js
      apt:
        name:
          - nodejs
        state: present
        update_cache: true

    - name: Verify Node.js installation
      command: node --version
      register: node_version
      changed_when: false

    - name: Display Node.js version
      debug:
        msg: "Node.js version: {{ node_version.stdout }}"

    - name: Derive forwardemail.net repository root
      set_fact:
        forwardemail_repo_root: "{{ playbook_dir | dirname | dirname }}"

    - name: Load local package.json for SnappyMail app version
      set_fact:
        snappymail_package_json: "{{ lookup('file', forwardemail_repo_root + '/package.json') | from_json }}"

    - name: Set SnappyMail app version fact
      set_fact:
        snappymail_app_version: "{{ snappymail_package_json.version | default('0.0.0', true) }}"

    - name: Install SnappyMail dependencies
      command: npm install
      args:
        chdir: /var/www/snappymail/mail
      become_user: deploy

    - name: Build SnappyMail with gulp
      command: npx gulp
      args:
        chdir: /var/www/snappymail/mail
      become_user: deploy

    - name: Check if dist directory exists
      stat:
        path: /var/www/snappymail/dist
      register: dist_dir

    - name: Remove old dist directory if it exists (as root)
      file:
        path: /var/www/snappymail/dist
        state: absent
      when: dist_dir.stat.exists
      become: true

    - name: Verify PHP CLI is available for build script
      command: which php
      register: php_path
      become_user: deploy
      changed_when: false
      failed_when: false

    - name: Display PHP path
      debug:
        msg: "PHP CLI path: {{ php_path.stdout if php_path.rc == 0 else 'NOT FOUND' }}"

    - name: Run build script to sync customizations
      command: ./scripts/build.sh
      args:
        chdir: /var/www/snappymail
      become_user: deploy
      environment:
        HOME: /home/deploy
        APP_VERSION: "{{ snappymail_app_version | default('0.0.0', true) }}"
        PATH: "/usr/local/bin:/usr/bin:/bin:{{ ansible_env.PATH }}"
      register: build_output

    - name: Display build script output
      debug:
        var: build_output.stdout_lines

    - name: Clear SnappyMail application cache
      shell: rm -rf /dev/shm/snappymail-cache/*
      ignore_errors: yes

    - name: Clear PHP OPcache after deployment
      shell: |
        # Try to reset opcache via PHP CLI
        php -r "if(function_exists('opcache_reset')) opcache_reset();" 2>/dev/null || true
      become_user: www-data
      environment:
        TMPDIR: /tmp
        TEMP: /tmp
        TMP: /tmp
      ignore_errors: yes

    - name: Restart PHP-FPM to ensure fresh opcache
      service:
        name: php8.2-fpm
        state: restarted

    - name: Set permissions on data directory
      file:
        path: /var/www/snappymail/dist/data
        state: directory
        owner: www-data
        group: www-data
        mode: '0700'
        recurse: true

    ##
    # Verify Plugin Deployment
    ##

    - name: Verify index.php has correct APP_VERSION
      shell: grep "define('APP_VERSION'" /var/www/snappymail/dist/index.php
      register: index_version
      changed_when: false

    - name: Display index.php APP_VERSION
      debug:
        msg: "index.php version: {{ index_version.stdout }}"

    - name: Check if forwardemail plugin exists in versioned directory
      stat:
        path: "/var/www/snappymail/dist/snappymail/v/{{ snappymail_app_version }}/plugins/forwardemail/index.php"
      register: plugin_file

    - name: Verify plugin file exists
      debug:
        msg: "Plugin exists at v/{{ snappymail_app_version }}/plugins/forwardemail: {{ plugin_file.stat.exists }}"

    - name: Check if plugin has new code (ensureCheckMailInterval)
      shell: grep -c "ensureCheckMailInterval" "/var/www/snappymail/dist/snappymail/v/{{ snappymail_app_version }}/plugins/forwardemail/index.php" || echo "0"
      register: plugin_has_new_code
      changed_when: false
      when: plugin_file.stat.exists

    - name: Display plugin code verification
      debug:
        msg: "Plugin has ensureCheckMailInterval: {{ 'YES' if (plugin_has_new_code.stdout | int) > 0 else 'NO' }}"
      when: plugin_file.stat.exists

    - name: Verify forwardemail in enabled_list
      shell: grep "enabled_list.*forwardemail" /var/www/snappymail/dist/data/_data_/_default_/configs/application.ini
      register: plugin_enabled
      changed_when: false
      failed_when: false

    - name: Display plugin enabled status
      debug:
        msg: "Plugin enabled in application.ini: {{ 'YES' if plugin_enabled.rc == 0 else 'NO - CHECK CONFIGURATION!' }}"

    - name: Check for recent plugin log messages
      shell: |
        LOG_FILE=$(ls -t /var/www/snappymail/dist/data/_data_/_default_/logs/*.log 2>/dev/null | head -1)
        if [ -n "$LOG_FILE" ]; then
          grep "Forward Email Plugin" "$LOG_FILE" 2>/dev/null | tail -5 || echo "No plugin messages found"
        else
          echo "No log files found"
        fi
      register: plugin_logs
      changed_when: false
      failed_when: false

    - name: Display recent plugin log messages
      debug:
        msg: "{{ plugin_logs.stdout_lines }}"

    ##
    # Configure Nginx Site
    ##

    - name: Deploy Nginx site configuration
      template:
        src: "{{ playbook_dir }}/templates/snappymail/snappymail-site.conf.j2"
        dest: /etc/nginx/sites-available/snappymail.conf
        owner: root
        group: root
        mode: '0644'
      notify: Reload Nginx

    - name: Enable Nginx site
      file:
        src: /etc/nginx/sites-available/snappymail.conf
        dest: /etc/nginx/sites-enabled/snappymail.conf
        state: link
      notify: Reload Nginx

    - name: Test Nginx configuration
      command: nginx -t
      changed_when: false

    ##
    # Health Check Cron
    ##

    - name: Create health check script
      copy:
        content: |
          #!/bin/bash
          # SnappyMail health check
          set -e
          systemctl is-active --quiet php8.2-fpm || systemctl restart php8.2-fpm
          systemctl is-active --quiet nginx || systemctl restart nginx
          curl -f -s http://localhost/ > /dev/null || exit 1
        dest: /usr/local/bin/snappymail-health-check
        owner: root
        group: root
        mode: '0755'

    - name: Add health check cron
      cron:
        name: "snappymail-health-check"
        minute: "*/5"
        job: "/usr/local/bin/snappymail-health-check > /dev/null 2>&1"
        user: root
