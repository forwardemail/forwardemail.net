---
- name: "System-Wide Optimization for All Servers"
  hosts: "{{ target_hosts | default('all') }}"
  become: true
  become_user: root
  tasks:
    # Configure tmpfs for /tmp (RAM-based temporary storage)
    - name: Check if /tmp is already mounted as tmpfs
      shell: mount | grep 'tmpfs on /tmp'
      register: tmp_tmpfs_check
      changed_when: false
      failed_when: false

    - name: Add tmpfs entry for /tmp to /etc/fstab
      lineinfile:
        path: /etc/fstab
        regexp: '^tmpfs\s+/tmp'
        line: 'tmpfs /tmp tmpfs defaults,noatime,nosuid,nodev,noexec,mode=1777,size=2G 0 0'
        state: present
      when: tmp_tmpfs_check.rc != 0

    # Note: We don't mount tmpfs immediately to avoid interfering with Ansible's /tmp usage
    # The tmpfs will be mounted on next reboot via /etc/fstab
    # To mount immediately after playbook completes, run: sudo mount -a

    - name: Display tmpfs configuration
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                                                                        â•‘
          â•‘                    ğŸ’¾ TMPFS /tmp CONFIGURATION                        â•‘
          â•‘                                                                        â•‘
          â•‘  {% if tmp_tmpfs_check.rc == 0 %}âœ… /tmp is already mounted as tmpfs (RAM-based storage)           â•‘{% else %}âœ… /tmp configured as tmpfs in /etc/fstab                           â•‘
          â•‘     Will be mounted on next reboot or run: sudo mount -a          â•‘{% endif %}
          â•‘                                                                        â•‘
          â•‘  Benefits:                                                            â•‘
          â•‘  â€¢ Reduces SSD wear by offloading temporary files to RAM              â•‘
          â•‘  â€¢ Improves performance for temporary file operations                 â•‘
          â•‘  â€¢ Enhanced security (cleared on reboot)                              â•‘
          â•‘  â€¢ Size limited to 2GB to prevent RAM exhaustion                      â•‘
          â•‘                                                                        â•‘
          â•‘  Mount options: noatime,nosuid,nodev,noexec,mode=1777,size=2G         â•‘
          â•‘                                                                        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # Harden /dev/shm to prevent execution (common attack vector)
    - name: Check current /dev/shm mount options
      shell: mount | grep '/dev/shm' | grep -o 'noexec'
      register: devshm_noexec_check
      changed_when: false
      failed_when: false

    - name: Harden /dev/shm with noexec and size limit
      mount:
        path: /dev/shm
        src: tmpfs
        fstype: tmpfs
        opts: defaults,nosuid,nodev,noexec,size=1G
        state: remounted
      when: devshm_noexec_check.rc != 0

    - name: Display /dev/shm hardening status
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                                                                        â•‘
          â•‘                    ğŸ”’ /dev/shm HARDENING                              â•‘
          â•‘                                                                        â•‘
          â•‘  {% if devshm_noexec_check.rc == 0 %}âœ… /dev/shm already hardened with noexec                          â•‘{% else %}âœ… /dev/shm hardened with noexec and size limit                   â•‘{% endif %}
          â•‘                                                                        â•‘
          â•‘  Security benefits:                                                   â•‘
          â•‘  â€¢ Prevents malware execution from /dev/shm (common attack vector)    â•‘
          â•‘  â€¢ Blocks cryptominers and rootkits using /dev/shm                    â•‘
          â•‘  â€¢ Size limited to 1GB (sufficient for legitimate shared memory)      â•‘
          â•‘  â€¢ Maintains POSIX shared memory functionality (PostgreSQL, Chrome)   â•‘
          â•‘                                                                        â•‘
          â•‘  Mount options: nosuid,nodev,noexec,size=1G                           â•‘
          â•‘                                                                        â•‘
          â•‘  Note: Applications using shared memory (mmap) still work normally    â•‘
          â•‘        Only direct execution is blocked for security                  â•‘
          â•‘                                                                        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # Optimize root filesystem mount options
    - name: Get root filesystem device
      shell: df / | tail -1 | awk '{print $1}'
      register: root_device_result
      changed_when: false

    - name: Get current mount options for root filesystem
      shell: |
        mount | grep "{{ root_device_result.stdout }}" | awk '{print $6}' | tr -d '()'
      register: root_mount_options_result
      changed_when: false

    - name: Get root filesystem type
      shell: |
        df -T / | tail -1 | awk '{print $2}'
      register: root_fstype_result
      changed_when: false

    - name: Check root filesystem mount options
      set_fact:
        has_noatime: "{{ 'noatime' in root_mount_options_result.stdout }}"
        has_nodiratime: "{{ 'nodiratime' in root_mount_options_result.stdout }}"
        has_discard: "{{ 'discard' in root_mount_options_result.stdout }}"
        needs_optimization: "{{ 'noatime' not in root_mount_options_result.stdout or 'nodiratime' not in root_mount_options_result.stdout or 'discard' not in root_mount_options_result.stdout }}"

    - name: Get fstab entry for root filesystem
      shell: |
        grep -E '\s+/\s+' /etc/fstab | grep -v '^#' | head -1
      register: fstab_root_entry
      changed_when: false
      failed_when: false

    - name: Extract current mount options from fstab
      shell: |
        echo "{{ fstab_root_entry.stdout }}" | awk '{print $4}'
      register: fstab_opts_result
      changed_when: false
      when: fstab_root_entry.rc == 0 and fstab_root_entry.stdout != ""

    - name: Build optimized mount options
      set_fact:
        current_opts_list: "{{ (fstab_opts_result.stdout | default('defaults')).split(',') }}"
      when: needs_optimization and fstab_root_entry.rc == 0

    - name: Remove conflicting options and add optimizations
      set_fact:
        optimized_opts: "{{ (current_opts_list | default(['defaults'])) | reject('in', ['relatime', 'atime']) | list + (['noatime'] if not has_noatime else []) + (['nodiratime'] if not has_nodiratime else []) + (['discard'] if not has_discard else []) | unique | join(',') }}"
      when: needs_optimization and fstab_root_entry.rc == 0

    - name: Backup /etc/fstab before modification
      copy:
        src: /etc/fstab
        dest: /etc/fstab.backup
        remote_src: yes
        mode: '0644'
      when: needs_optimization and fstab_root_entry.rc == 0

    - name: Update root filesystem mount options in /etc/fstab
      shell: |
        # Get the current fstab line for root filesystem
        CURRENT_LINE=$(grep -E '\s+/\s+' /etc/fstab | grep -v '^#' | head -1)
        
        # Extract components
        DEVICE=$(echo "$CURRENT_LINE" | awk '{print $1}')
        MOUNTPOINT=$(echo "$CURRENT_LINE" | awk '{print $2}')
        FSTYPE=$(echo "$CURRENT_LINE" | awk '{print $3}')
        DUMP=$(echo "$CURRENT_LINE" | awk '{print $5}')
        PASS=$(echo "$CURRENT_LINE" | awk '{print $6}')
        
        # Build new line with optimized options
        NEW_LINE="$DEVICE $MOUNTPOINT $FSTYPE {{ optimized_opts }} $DUMP $PASS"
        
        # Use sed to replace the line in-place
        sed -i.bak "/^\s*[^#].*\s\+\/\s\+/c\\$NEW_LINE" /etc/fstab
      when: needs_optimization and fstab_root_entry.rc == 0
      register: fstab_update_result
      changed_when: true

    - name: Remount root filesystem with optimized options
      shell: |
        mount -o remount,{{ optimized_opts }} /
      when: needs_optimization and fstab_root_entry.rc == 0
      register: remount_result
      changed_when: true

    - name: Verify root filesystem remount
      shell: |
        mount | grep "{{ root_device_result.stdout }}" | awk '{print $6}' | tr -d '()'
      register: verify_mount_options
      changed_when: false
      when: needs_optimization

    - name: Display root filesystem optimization status
      shell: |
        cat << 'MOUNT_STATUS'
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘                                                                        â•‘
        â•‘              ğŸ“ ROOT FILESYSTEM MOUNT OPTIMIZATION                    â•‘
        â•‘                                                                        â•‘
        â•‘  Device: {{ root_device_result.stdout }}
        â•‘  Filesystem: {{ root_fstype_result.stdout }}
        â•‘  {% if needs_optimization %}Before: {{ root_mount_options_result.stdout }}
        â•‘  After:  {{ verify_mount_options.stdout | default('N/A') }}{% else %}Current: {{ root_mount_options_result.stdout }}{% endif %}
        â•‘                                                                        â•‘
        â•‘  {% if needs_optimization %}âœ… Optimizations Applied:                                              â•‘
        â•‘  {% if not has_noatime %}  â€¢ noatime added - Disables file access time updates                â•‘{% endif %}
        â•‘  {% if not has_nodiratime %}  â€¢ nodiratime added - Disables directory access time updates       â•‘{% endif %}
        â•‘  {% if not has_discard %}  â€¢ discard added - Enables TRIM for SSD longevity                 â•‘{% endif %}
        â•‘                                                                        â•‘
        â•‘  Changes:                                                             â•‘
        â•‘  â€¢ /etc/fstab updated (backup: /etc/fstab.backup)                     â•‘
        â•‘  â€¢ Root filesystem remounted with new options                         â•‘
        â•‘  â€¢ Changes persist across reboots                                     â•‘{% else %}âœ… All mount options already optimized - no changes needed            â•‘{% endif %}
        â•‘                                                                        â•‘
        â•‘  Benefits:                                                            â•‘
        â•‘  â€¢ Reduced I/O overhead (no access time updates)                      â•‘
        â•‘  â€¢ Extended SSD lifespan (TRIM support)                               â•‘
        â•‘  â€¢ Improved filesystem performance                                    â•‘
        â•‘                                                                        â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        MOUNT_STATUS
      args:
        executable: /bin/bash
      register: mount_status_output
      changed_when: false

    - name: Show mount optimization status
      debug:
        msg: "{{ mount_status_output.stdout_lines }}"
