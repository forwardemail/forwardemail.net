# Copyright (c) Forward Email LLC
# SPDX-License-Identifier: BUSL-1.1

---
- name: Import Unbound DNS caching playbook
  import_playbook: unbound.yml

- hosts: all
  name: Security
  become: true
  become_user: root
  vars:
    copy_local_key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa.pub') }}"
    copy_local_key_2: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa_2.pub') }}"
  handlers:
    - name: Restart SSH
      service:
        name: ssh
        state: restarted
    - name: Restart Postfix
      service:
        name: postfix
        state: restarted
    - name: Reload auditd rules
      command: augenrules --load
      changed_when: false
    - name: Restart rsyslog
      service:
        name: rsyslog
        state: restarted
  tasks:
    - name: Delete Digital Ocean Networking Configuration
      ansible.builtin.file:
        state: absent
        path: /etc/systemd/resolved.conf.d/DigitalOcean.conf

    - name: Remove Ubuntu Advantage Tools
      apt:
        pkg: ubuntu-advantage-tools
        state: absent

    - name: Purge Ubuntu Advantage Tools
      apt:
        autoremove: yes
        purge: true
        name:
          - ubuntu-advantage-tools

    - name: Insert/Update disable core dumps
      blockinfile:
        path: /etc/security/limits.conf
        state: present
        block: |
          * hard core 0
          * soft core 0

    # https://www.mongodb.com/docs/manual/tutorial/transparent-huge-pages/
    # https://unix.stackexchange.com/questions/99154/disable-transparent-hugepages
    # https://stackoverflow.com/questions/51246128/disabling-thp-transparent-hugepages-with-ansible-role
    - name: "Disable Transparent Huge Pages (THP)"
      template:
        src: "{{ playbook_dir }}/templates/thp.j2"
        dest: /etc/systemd/system/disable-transparent-huge-pages.service
        owner: root
        mode: "0644"

    - name: "Enable Disabled THP Systemd Service"
      service:
        daemon_reload: yes
        name: disable-transparent-huge-pages
        enabled: true
        state: started

    - name: Ensure fs.suid_dumpable is set to 0 and added in sysctl
      ansible.posix.sysctl:
        name: fs.suid_dumpable
        value: "0"
        sysctl_set: true

    - name: Insert/Update disable core dumps
      blockinfile:
        path: /etc/profile
        state: present
        block: |
          ulimit -S -c 0 > /dev/null 2>&1

    # Disable swap entirely on non-database servers
    # MongoDB and Redis need swap as a last resort (with vm.swappiness=1)
    # https://unix.stackexchange.com/a/636526
    - name: Disable swap for current session
      command: swapoff -a
      when: "'mongo' not in group_names and 'redis' not in group_names"
    - name: Disable swap permanently, persist reboots
      replace:
        path: /etc/fstab
        regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
        replace: '#\1\2\3swap\4'
        backup: yes
      when: "'mongo' not in group_names and 'redis' not in group_names"
    - name: Disable swap on boot via systemd
      template:
        src: "{{ playbook_dir }}/templates/noswap.j2"
        dest: /etc/systemd/system/noswap.service
        owner: root
        mode: "0644"
      when: "'mongo' not in group_names and 'redis' not in group_names"
    - name: Enable noswap service via systemd
      systemd:
        daemon_reload: yes
        name: noswap
        enabled: true
        state: started
      when: "'mongo' not in group_names and 'redis' not in group_names"

    # Disable Modprobe Loading of USB Storage Driver
    # https://docs.datadoghq.com/security/default_rules/xccdf-org-ssgproject-content-rule-kernel-module-usb-storage-disabled/
    - name: Ensure kernel module 'usb-storage' is disabled
      lineinfile:
        create: true
        dest: /etc/modprobe.d/usb-storage.conf
        regexp: install\s+usb-storage
        line: install usb-storage /bin/true

    - name: Update initramfs
      shell: |
        sudo update-initramfs -u

    # TODO: Disable Accepting ICMP Redirects for All IPv4 Interfaces
    #       https://docs.datadoghq.com/security/default_rules/xccdf-org-ssgproject-content-rule-sysctl-net-ipv4-conf-all-accept-redirects/#ansible-playbook

    # Disable Apport Service
    # https://docs.datadoghq.com/security/default_rules/xccdf-org-ssgproject-content-rule-service-apport-disabled/#ansible-playbook
    - name: Disable service apport
      systemd:
        name: apport.service
        enabled: 'no'
        state: stopped
        masked: 'yes'
    # NOTE: this does not seem necessary since apport.socket does not exist
    #- name: Disable socket apport
    #  systemd:
    #    name: apport.socket
    #    enabled: 'no'
    #    state: stopped
    #    masked: 'yes'
    - name: Disable apport via config
      block:
        - name: Deduplicate values from /etc/default/apport
          lineinfile:
            path: /etc/default/apport
            create: false
            line: enabled=1
            state: absent
        - name: Insert correct line to /etc/default/apport
          lineinfile:
            path: /etc/default/apport
            create: false
            line: enabled=0
            state: present

    #
    # Disable coredump backtraces
    # https://docs.datadoghq.com/security/default_rules/xccdf-org-ssgproject-content-rule-coredump-disable-backtraces/
    #
    - name: Disable core dump backtraces
      block:
        - name: Check for duplicate values
          lineinfile:
            path: /etc/systemd/coredump.conf
            create: true
            regexp: ^\s\*ProcessSizeMax\s\*=\s\*
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
        - name: Deduplicate values from /etc/systemd/coredump.conf
          lineinfile:
            path: /etc/systemd/coredump.conf
            create: true
            regexp: ^\s\*ProcessSizeMax\s\*=\s\*
            state: absent
          when: dupes.found is defined and dupes.found > 1
        - name: Insert correct line to /etc/systemd/coredump.conf
          lineinfile:
            path: /etc/systemd/coredump.conf
            create: true
            regexp: ^\s\*ProcessSizeMax\s\*=\s\*
            line: ProcessSizeMax=0
            state: present

    # update deps
    - name: Update apt
      apt:
        update_cache: true

    # upgrade deps
    - name: Upgrade deps
      apt:
        upgrade: safe
        update_cache: true

    # install deps
    - name: Install deps
      apt:
        name:
          - iptables
          - ipset
          - build-essential
          - curl
          - ufw
          - git
          - vim
          - wget
          - libtool
          - automake
          - autoconf
          - nasm
          - ripgrep
          - redis-tools
          - mailutils
          - postfix
          - libsasl2-modules
        update_cache: true

    # prevents port scanning
    # https://github.com/forwardemail/portscan-protection
    # (we maintain our own fork since it has an auto-update in place)
    # https://unix.stackexchange.com/a/580520
    # Deploy from local file to avoid GitHub rate limiting
    - name: Copy portscan protection script to server
      copy:
        src: "{{ playbook_dir }}/files/portscan-protection.sh"
        dest: /tmp/portscan-protection.sh
        mode: '0755'

    - name: Run portscan protection script
      shell: /tmp/portscan-protection.sh -i
      register: port_scan
      failed_when: port_scan.rc != 1

    - name: Remove temporary portscan script
      file:
        path: /tmp/portscan-protection.sh
        state: absent

    # Configure Postfix for SMTP relay (sendmail)
    # This allows system services to send email alerts
    - name: Set Postfix to use SMTP relay
      debconf:
        name: postfix
        question: postfix/main_mailer_type
        value: 'Internet Site'
        vtype: string

    - name: Remove duplicate Postfix entries outside Ansible managed block
      shell: |
        # Remove relayhost and smtp_tls_security_level lines that are NOT within Ansible managed blocks
        if [ -f /etc/postfix/main.cf ]; then
          # Create a backup
          cp /etc/postfix/main.cf /etc/postfix/main.cf.bak
          
          # Use awk to remove duplicates outside managed blocks
          awk '
            /^# BEGIN ANSIBLE MANAGED BLOCK/ { in_block=1 }
            /^# END ANSIBLE MANAGED BLOCK/ { in_block=0; print; next }
            in_block { print; next }
            !/^relayhost\s*=/ && !/^smtp_tls_security_level\s*=/ { print }
          ' /etc/postfix/main.cf.bak > /etc/postfix/main.cf
          
          # Check if file changed
          if ! diff -q /etc/postfix/main.cf.bak /etc/postfix/main.cf > /dev/null; then
            echo "changed"
          fi
        fi
      register: postfix_cleanup
      changed_when: "'changed' in postfix_cleanup.stdout"
      notify: Restart Postfix

    - name: Configure Postfix main.cf for SMTP relay
      blockinfile:
        path: /etc/postfix/main.cf
        create: yes
        block: |
          # SMTP relay configuration for email alerts
          relayhost = [{{ lookup('env', 'SMTP_HOST') | default('smtp.forwardemail.net') }}]:{{ lookup('env', 'SMTP_PORT') | default('465') }}
          smtp_use_tls = yes
          smtp_sasl_auth_enable = yes
          smtp_sasl_security_options = noanonymous
          smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
          smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt
          smtp_tls_wrappermode = yes
          smtp_tls_security_level = encrypt
          
          # Set sender address
          sender_canonical_maps = regexp:/etc/postfix/sender_canonical
        marker: "# {mark} ANSIBLE MANAGED BLOCK - SMTP RELAY"
      notify: Restart Postfix

    - name: Create SASL password file
      copy:
        dest: /etc/postfix/sasl_passwd
        content: |
          [{{ lookup('env', 'SMTP_HOST') | default('smtp.forwardemail.net') }}]:{{ lookup('env', 'SMTP_PORT') | default('465') }} {{ lookup('env', 'POSTFIX_USERNAME') }}:{{ lookup('env', 'POSTFIX_PASSWORD') }}
        mode: '0600'
        owner: root
        group: root
      no_log: true
      notify: Restart Postfix

    - name: Hash SASL password file
      command: postmap /etc/postfix/sasl_passwd
      notify: Restart Postfix

    - name: Create sender canonical map
      copy:
        dest: /etc/postfix/sender_canonical
        content: |
          /^.*$/ {{ lookup('env', 'POSTFIX_USERNAME') }}
        mode: '0644'
        owner: root
        group: root
      notify: Restart Postfix

    - name: Ensure Postfix is enabled and started
      systemd:
        name: postfix
        enabled: yes
        state: started

    # Configure systemd failure notifications
    # Deploy rate-limited email script
    - name: Install jq for rate limiting
      apt:
        name: jq
        state: present
        update_cache: yes

    - name: Deploy rate-limited email script
      template:
        src: "{{ playbook_dir }}/templates/send-rate-limited-email.sh.j2"
        dest: /usr/local/bin/send-rate-limited-email.sh
        owner: root
        group: root
        mode: '0755'

    - name: Create rate limit directory
      file:
        path: /var/lib/email-rate-limits
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Deploy failure notification script
      template:
        src: "{{ playbook_dir }}/templates/send-failure-notification.sh.j2"
        dest: /usr/local/bin/send-failure-notification.sh
        owner: root
        group: root
        mode: '0755'

    - name: Deploy systemd failure notification service template
      template:
        src: "{{ playbook_dir }}/templates/failure-notification@.service.j2"
        dest: /etc/systemd/system/failure-notification@.service
        owner: root
        group: root
        mode: '0644'

    - name: Reload systemd daemon for failure notification service
      systemd:
        daemon_reload: yes

    # Deploy security monitoring scripts
    - name: Create security monitor configuration directory
      file:
        path: /etc/security-monitor
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create authorized IPs whitelist file
      copy:
        dest: /etc/security-monitor/authorized-ips.conf
        content: |
          # Authorized IP addresses (one per line)
          # Example: 192.168.1.100
        mode: '0644'
        owner: root
        group: root
        force: no

    - name: Create authorized users whitelist file
      copy:
        dest: /etc/security-monitor/authorized-users.conf
        content: |
          # Authorized users (one per line)
          devops
          deploy
        mode: '0644'
        owner: root
        group: root
        force: no

    - name: Create authorized USB devices whitelist file
      copy:
        dest: /etc/security-monitor/authorized-usb-devices.conf
        content: |
          # Authorized USB devices (vendor:product format, one per line)
          # Example: 1234:5678
          # Get IDs using: lsusb
        mode: '0644'
        owner: root
        group: root
        force: no

    - name: Create authorized root users whitelist file
      copy:
        dest: /etc/security-monitor/authorized-root-users.conf
        content: |
          # Authorized root users (one per line)
          devops
        mode: '0644'
        owner: root
        group: root
        force: no

    - name: Create authorized sudo users whitelist file
      copy:
        dest: /etc/security-monitor/authorized-sudo-users.conf
        content: |
          # Authorized sudo users (one per line)
          devops
        mode: '0644'
        owner: root
        group: root
        force: no

    # Create state directories for monitoring systems
    - name: Create Lynis audit monitor state directory
      file:
        path: /var/lib/lynis-audit-monitor
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create package monitor state directory
      file:
        path: /var/lib/package-monitor
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create open ports monitor state directory
      file:
        path: /var/lib/open-ports-monitor
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Deploy system resource monitor script
      copy:
        src: "{{ playbook_dir }}/files/system-resource-monitor.sh"
        dest: /usr/local/bin/system-resource-monitor.sh
        owner: root
        group: root
        mode: '0755'

    - name: Deploy SSH security monitor script
      copy:
        src: "{{ playbook_dir }}/files/ssh-security-monitor.sh"
        dest: /usr/local/bin/ssh-security-monitor.sh
        owner: root
        group: root
        mode: '0755'

    - name: Deploy USB device monitor script
      copy:
        src: "{{ playbook_dir }}/files/usb-device-monitor.sh"
        dest: /usr/local/bin/usb-device-monitor.sh
        owner: root
        group: root
        mode: '0755'

    - name: Deploy root access monitor script
      copy:
        src: "{{ playbook_dir }}/files/root-access-monitor.sh"
        dest: /usr/local/bin/root-access-monitor.sh
        owner: root
        group: root
        mode: '0755'

    - name: Deploy Lynis audit monitor script
      copy:
        src: "{{ playbook_dir }}/files/lynis-audit-monitor.sh"
        dest: /usr/local/bin/lynis-audit-monitor.sh
        owner: root
        group: root
        mode: '0755'

    - name: Deploy package monitor script
      copy:
        src: "{{ playbook_dir }}/files/package-monitor.sh"
        dest: /usr/local/bin/package-monitor.sh
        owner: root
        group: root
        mode: '0755'

    - name: Deploy open ports monitor script
      copy:
        src: "{{ playbook_dir }}/files/open-ports-monitor.sh"
        dest: /usr/local/bin/open-ports-monitor.sh
        owner: root
        group: root
        mode: '0755'

    - name: Deploy SSL certificate monitor script
      copy:
        src: "{{ playbook_dir }}/files/ssl-certificate-monitor.sh"
        dest: /usr/local/bin/ssl-certificate-monitor.sh
        owner: root
        group: root
        mode: '0755'

    # Deploy systemd service units
    - name: Deploy system resource monitor service
      template:
        src: "{{ playbook_dir }}/templates/system-resource-monitor.service.j2"
        dest: /etc/systemd/system/system-resource-monitor.service
        owner: root
        group: root
        mode: '0644'

    - name: Deploy system resource monitor timer
      template:
        src: "{{ playbook_dir }}/templates/system-resource-monitor.timer.j2"
        dest: /etc/systemd/system/system-resource-monitor.timer
        owner: root
        group: root
        mode: '0644'

    - name: Deploy SSH security monitor service
      template:
        src: "{{ playbook_dir }}/templates/ssh-security-monitor.service.j2"
        dest: /etc/systemd/system/ssh-security-monitor.service
        owner: root
        group: root
        mode: '0644'

    - name: Deploy SSH security monitor timer
      template:
        src: "{{ playbook_dir }}/templates/ssh-security-monitor.timer.j2"
        dest: /etc/systemd/system/ssh-security-monitor.timer
        owner: root
        group: root
        mode: '0644'

    - name: Deploy USB device monitor service
      template:
        src: "{{ playbook_dir }}/templates/usb-device-monitor.service.j2"
        dest: /etc/systemd/system/usb-device-monitor.service
        owner: root
        group: root
        mode: '0644'

    - name: Deploy USB device monitor timer
      template:
        src: "{{ playbook_dir }}/templates/usb-device-monitor.timer.j2"
        dest: /etc/systemd/system/usb-device-monitor.timer
        owner: root
        group: root
        mode: '0644'

    - name: Deploy USB device monitor udev rules
      template:
        src: "{{ playbook_dir }}/templates/usb-monitor.rules.j2"
        dest: /etc/udev/rules.d/99-usb-monitor.rules
        owner: root
        group: root
        mode: '0644'

    - name: Deploy root access monitor service
      template:
        src: "{{ playbook_dir }}/templates/root-access-monitor.service.j2"
        dest: /etc/systemd/system/root-access-monitor.service
        owner: root
        group: root
        mode: '0644'

    - name: Deploy root access monitor timer
      template:
        src: "{{ playbook_dir }}/templates/root-access-monitor.timer.j2"
        dest: /etc/systemd/system/root-access-monitor.timer
        owner: root
        group: root
        mode: '0644'

    - name: Deploy Lynis audit monitor service
      template:
        src: "{{ playbook_dir }}/templates/lynis-audit-monitor.service.j2"
        dest: /etc/systemd/system/lynis-audit-monitor.service
        owner: root
        group: root
        mode: '0644'

    - name: Deploy Lynis audit monitor timer
      template:
        src: "{{ playbook_dir }}/templates/lynis-audit-monitor.timer.j2"
        dest: /etc/systemd/system/lynis-audit-monitor.timer
        owner: root
        group: root
        mode: '0644'

    - name: Deploy package monitor service
      template:
        src: "{{ playbook_dir }}/templates/package-monitor.service.j2"
        dest: /etc/systemd/system/package-monitor.service
        owner: root
        group: root
        mode: '0644'

    - name: Deploy package monitor timer
      template:
        src: "{{ playbook_dir }}/templates/package-monitor.timer.j2"
        dest: /etc/systemd/system/package-monitor.timer
        owner: root
        group: root
        mode: '0644'

    - name: Deploy open ports monitor service
      template:
        src: "{{ playbook_dir }}/templates/open-ports-monitor.service.j2"
        dest: /etc/systemd/system/open-ports-monitor.service
        owner: root
        group: root
        mode: '0644'

    - name: Deploy open ports monitor timer
      template:
        src: "{{ playbook_dir }}/templates/open-ports-monitor.timer.j2"
        dest: /etc/systemd/system/open-ports-monitor.timer
        owner: root
        group: root
        mode: '0644'

    - name: Deploy SSL certificate monitor service
      template:
        src: "{{ playbook_dir }}/templates/ssl-certificate-monitor.service.j2"
        dest: /etc/systemd/system/ssl-certificate-monitor.service
        owner: root
        group: root
        mode: '0644'

    - name: Deploy SSL certificate monitor timer
      template:
        src: "{{ playbook_dir }}/templates/ssl-certificate-monitor.timer.j2"
        dest: /etc/systemd/system/ssl-certificate-monitor.timer
        owner: root
        group: root
        mode: '0644'

    # Reload systemd and enable monitoring services
    - name: Reload systemd daemon for monitoring services
      systemd:
        daemon_reload: yes

    - name: Enable and start system resource monitor timer
      systemd:
        name: system-resource-monitor.timer
        enabled: yes
        state: started

    - name: Enable and start SSH security monitor timer
      systemd:
        name: ssh-security-monitor.timer
        enabled: yes
        state: started

    - name: Enable and start USB device monitor timer
      systemd:
        name: usb-device-monitor.timer
        enabled: yes
        state: started

    - name: Enable and start root access monitor timer
      systemd:
        name: root-access-monitor.timer
        enabled: yes
        state: started

    - name: Enable and start Lynis audit monitor timer
      systemd:
        name: lynis-audit-monitor.timer
        enabled: yes
        state: started

    - name: Enable and start package monitor timer
      systemd:
        name: package-monitor.timer
        enabled: yes
        state: started

    - name: Enable and start open ports monitor timer
      systemd:
        name: open-ports-monitor.timer
        enabled: yes
        state: started

    - name: Enable and start SSL certificate monitor timer
      systemd:
        name: ssl-certificate-monitor.timer
        enabled: yes
        state: started

    - name: Reload udev rules for USB monitoring
      command: udevadm control --reload-rules

    - name: Trigger udev rules
      command: udevadm trigger

    # Configure comprehensive command logging
    - name: Install auditd for command logging
      apt:
        name: auditd
        state: present
        update_cache: yes

    - name: Deploy audit rules for command logging
      copy:
        src: "{{ playbook_dir }}/files/audit-commands.rules"
        dest: /etc/audit/rules.d/audit-commands.rules
        owner: root
        group: root
        mode: '0640'
      notify: Reload auditd rules

    - name: Deploy bash command logging configuration
      copy:
        src: "{{ playbook_dir }}/files/bash-logging.sh"
        dest: /etc/profile.d/bash-logging.sh
        owner: root
        group: root
        mode: '0644'
    - name: Create zsh configuration directory
      file:
        path: /etc/zsh/zshrc.d
        state: directory
        owner: root
        group: root
        mode: '0755'
    - name: Deploy zsh command logging configuration
      copy:
        src: "{{ playbook_dir }}/files/bash-logging.sh"
        dest: /etc/zsh/zshrc.d/command-logging.zsh
        owner: root
        group: root
        mode: '0644'
    - name: Ensure zshrc sources zshrc.d directory
      blockinfile:
        path: /etc/zsh/zshrc
        create: yes
        block: |
          # Source command logging
          if [ -d /etc/zsh/zshrc.d ]; then
            for file in /etc/zsh/zshrc.d/*.zsh; do
              [ -r "$file" ] && source "$file"
            done
          fi
        owner: root
        group: root
        mode: '0644'

    - name: Configure rsyslog to capture bash commands
      blockinfile:
        path: /etc/rsyslog.d/50-bash-logging.conf
        create: yes
        block: |
          # Log bash commands to separate file
          if $programname == 'bash_command' or $programname == 'zsh_command' then {
              action(type="omfile" file="/var/log/bash-commands.log" FileOwner="syslog" FileGroup="adm" FileCreateMode="0640")
              stop
          }
        owner: root
        group: root
        mode: '0644'
      notify: Restart rsyslog

    - name: Create bash commands log file
      file:
        path: /var/log/bash-commands.log
        state: touch
        owner: syslog
        group: adm
        mode: '0640'

    - name: Configure logrotate for bash commands log
      copy:
        dest: /etc/logrotate.d/bash-commands
        content: |
          /var/log/bash-commands.log {
              daily
              rotate 30
              compress
              delaycompress
              missingok
              notifempty
              create 0640 syslog adm
              sharedscripts
              postrotate
                  /usr/lib/rsyslog/rsyslog-rotate
              endscript
          }
        owner: root
        group: root
        mode: '0644'

    # create devops group
    - name: Create devops group
      group:
        name: devops
        state: present

    - name: Set devops group to have sudo access
      lineinfile:
        path: /etc/sudoers
        state: present
        regexp: ^%devops
        line: "%devops ALL=(ALL) NOPASSWD: ALL"
        validate: /usr/sbin/visudo -cf %s

    # create devops user (with sudo)
    - name: Create a devops user with sudo privileges
      user:
        name: devops
        password: "!"
        state: present
        groups: devops
        append: true
        create_home: true
        shell: /bin/bash

    - name: Set authorized key for devops user
      authorized_key:
        user: devops
        state: present
        key: "{{ copy_local_key }}"

    - name: Set authorized key 2 for devops user
      authorized_key:
        user: devops
        state: present
        key: "{{ copy_local_key_2 }}"

    # create deploy user
    - name: Create a deploy user
      user:
        name: deploy
        password: "!"
        state: present
        create_home: true
        shell: /bin/bash
        generate_ssh_key: true
        ssh_key_bits: 4096

    - name: Set authorized key for deploy user
      authorized_key:
        user: deploy
        state: present
        key: "{{ copy_local_key }}"

    - name: Set authorized key 2 for deploy user
      authorized_key:
        user: deploy
        state: present
        key: "{{ copy_local_key_2 }}"

    - name: Remove non-interactive from deploy bashrc
      ansible.builtin.replace:
        path: /home/deploy/.bashrc
        regexp: "{{ '      *) return;;' | regex_escape() }}"
        replace: "      *) :;"
      tags:
        - bash

    # disable root login
    - name: Disable root login
      lineinfile:
        path: /etc/ssh/sshd_config
        line: "{{ item.key }} {{ item.value }}"
        state: "{{ item.state }}"
      loop:
        - { key: PermitRootLogin, value: "yes", state: absent }
        - { key: PasswordAuthentication, value: "yes", state: absent }
        - { key: PermitRootLogin, value: "no", state: present }
        - { key: PasswordAuthentication, value: "no", state: present }

    # https://superuser.com/a/1578266
    - name: Disable root password
      user:
        name: root
        password_lock: true
      notify: Restart SSH

    # modify ulimit for devops and deploy
    # https://gist.github.com/visualskyrim/8d93a8be0a3ef6dd6598ec8550f6eadd#file-modify_ulimit-yml-L7
    - name: Configure system settings, file descriptors and number of threads
      pam_limits:
        domain: "*"
        limit_type: "{{ item.limit_type }}"
        limit_item: "{{ item.limit_item }}"
        value: "{{ item.value }}"
      with_items:
        - { limit_type: "-", limit_item: nofile, value: 65536 }
        - { limit_type: "-", limit_item: nproc, value: 65536 }
        - { limit_type: soft, limit_item: memlock, value: unlimited }
        - { limit_type: hard, limit_item: memlock, value: unlimited }
    - name: Reload settings from all system configuration files
      shell: sysctl --system

    # Silence dubious ownership git warning
    - name: Silence git safe dir warning
      become: true
      become_user: deploy
      shell: git config --global --add safe.directory '*'

- hosts: all
  name: Mongo Shell
  become: true
  become_user: root
  tasks:
    - name: Setup keys
      shell: |
        wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -
        echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu $(lsb_release -c -s)/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
    - name: Install package
      apt:
        name:
          - mongodb-mongosh
        update_cache: true

- hosts: all
  name: Sysctl
  become: true
  become_user: root
  vars:
    #
    # kernel tuning and performance optimizations
    #
    # https://medium.com/@k1d_bl4ck/a-quick-story-about-node-js-socket-io-and-the-linux-tcp-stack-bf1e8318b20e
    # https://gist.github.com/vongosling/9929680
    # https://wiki.mikejung.biz/Sysctl_tweaks
    # https://docs.continuent.com/tungsten-clustering-6.1/performance-networking.html
    # https://www.vpndada.com/how-to-setup-a-shadowsocks-server-on-digitalocean/
    #
    # TODO: we should research more configuration settings from these links:
    #       https://udgwebdev.github.io/tunning-em-servidor-linux/
    #       https://gist.github.com/voluntas/bc54c60aaa7ad6856e6f6a928b79ab6c
    #       https://serverdiary.com/linux/how-to-mitigate-tcp-syn-flood-attack-and-resolve-it-on-linux/
    #
    sysctl_settings:
      # disable coredump
      - name: fs.suid_dumpable
        value: 0
      - name: kernel.core_pattern
        value: "|/bin/false"

      # Enable Randomized Layout of Virtual Address Space
      # https://docs.datadoghq.com/security/default_rules/xccdf-org-ssgproject-content-rule-sysctl-kernel-randomize-va-space/
      - name: kernel.randomize_va_space
        value: 2

      #
      # socat has IPv6 issues and is hard to configure
      # authbind et all also have their own issues and configuration pains
      # this is an extremely simple and straightforward way to allow port binding
      #
      # <https://ar.al/2022/08/30/dear-linux-privileged-ports-must-die/>
      # <https://stackoverflow.com/a/51439516>
      # <https://github.com/moby/moby/pull/41030/files#diff-9f91bff23e0bd70d6429b63d9db2d8180d2e89cdb64db4fb3e10a96f74d36271R792>
      #
      - name: net.ipv4.ip_unprivileged_port_start
        value: 25

      #
      # handle ufw forwarding
      #
      - name: net.ipv4.ip_forward
        value: 0
      - name: net.ipv6.conf.default.forwarding
        value: 0
      - name: net.ipv6.conf.all.forwarding
        value: 0

      # handle swapping idle processes to disk
      # https://medium.com/@sauravomar01/linux-kernel-tuning-and-performance-tweaks-d7848178aaa2
      - name: vm.swappiness
        value: 0
      - name: vm.dirty_ratio
        value: 60
      - name: vm.dirty_background_ratio
        value: 2
      - name: vm.vfs_cache_pressure
        value: 50

      # allow local port range
      - name: net.ipv4.ip_local_port_range
        value: 1024 65535

      #
      # increase amount of option memory buffers
      # Dynamic scaling based on RAM (used for ancillary data, MSG_ZEROCOPY, etc.)
      # Scales conservatively with available memory
      #
      - name: net.core.optmem_max
        value: >-
          {% if ansible_memtotal_mb >= 65536 %}
          134217728
          {% elif ansible_memtotal_mb >= 32768 %}
          67108864
          {% elif ansible_memtotal_mb >= 16384 %}
          33554432
          {% else %}
          25165824
          {% endif %}

      # max number of concurrently open files
      - name: fs.file-max
        value: 2097152

      # increase the max number of "backlogged sockets" (default: 128)
      # (max number of connections that can be queued for acceptance)
      # Increased to 16384 for high-traffic email server (IMAP, SMTP, POP3, WebSocket)
      - name: net.core.somaxconn
        value: 16384

      # length of time orphaned (unreferenced) connection will wait (default: 60)
      # Lowered to 20s for faster resource reclamation on high-traffic servers
      - name: net.ipv4.tcp_fin_timeout
        value: 20

      #
      # allow more aggressive network throughput
      # https://en.wikipedia.org/wiki/TCP_window_scale_option
      #
      - name: net.ipv4.tcp_window_scaling
        value: 1

      #
      # configure tcp keepalive
      # https://webhostinggeeks.com/howto/configure-linux-tcp-keepalive-setting/
      #
      - name: net.ipv4.tcp_keepalive_time
        value: 60
      - name: net.ipv4.tcp_keepalive_intvl
        value: 10
      #
      # NOTE: it seems like this was removed in newer kernels
      # `sysctl: cannot stat /proc/sys/net/ipv4/tcp_tw_recycle: No such file or directory`
      #
      # - name: net.ipv4.tcp_keepalive_probe
      # - value: 6

      # max remembered connection requests which did not yet receive ACK (default: 1024)
      # (how many half-open connections can be kept in the queue)
      # Should match or exceed net.core.somaxconn
      - name: net.ipv4.tcp_max_syn_backlog
        value: 16384

      # increase system ip port limts to allow for more connections
      - name: net.ipv4.ip_local_port_range
        value: 1024 65535

      # number of packets queued on INPUT (default: 1000)
      # Increased to handle high packet rates on email servers
      - name: net.core.netdev_max_backlog
        value: 16384

      #
      # Network congestion control and queue discipline
      # fq_codel is the Linux kernel default since 4.12 (2017) and optimal for CUBIC
      # Provides fair queueing + Active Queue Management (AQM) with CoDel
      # Best for mixed workloads, bufferbloat prevention, and reliability
      # https://fasterdata.es.net/host-tuning/linux/
      # Note: http.yml overrides this with BBR + fq for HTTP servers
      #
      - name: net.core.default_qdisc
        value: fq_codel
      - name: net.ipv4.tcp_congestion_control
        value: cubic
      - name: net.ipv4.tcp_notsent_lowat
        value: 16384

      # protect against tcp time-wait
      - name: net.ipv4.tcp_rfc1337
        value: 1

      #
      # number of sockets in the "time-wait" state allowed to exist (prevents simple DOS attacks)
      # https://easyengine.io/tutorials/linux/sysctl-conf/
      # https://docs.continuent.com/tungsten-clustering-5.4/performance-networking.html
      #
      - name: net.ipv4.tcp_max_tw_buckets
        value: 1440000

      #
      # we do not use this because it does not work well with load balancers
      # and it also was removed from linux in v4.12
      # https://stackoverflow.com/questions/6426253/tcp-tw-reuse-vs-tcp-tw-recycle-which-to-use-or-both
      #
      # NOTE: this was removed/deprecated in newer kernels
      # `sysctl: cannot stat /proc/sys/net/ipv4/tcp_tw_recycle: No such file or directory`
      #
      # - name: net.ipv4.tcp_tw_recycle
      #   value: 0

      # allow to reuse TIME_WAIT sockets for new connections when safe from protocol
      - name: net.ipv4.tcp_tw_reuse
        value: 1

      #
      # TCP receive buffer (min default max)
      # Dynamic scaling based on RAM for large email attachments and bulk operations
      # Conservative scaling to prevent excessive memory usage with many connections
      # https://fasterdata.es.net/host-tuning/linux/
      #
      - name: net.ipv4.tcp_rmem
        value: >-
          {% if ansible_memtotal_mb >= 65536 %}
          4096 131072 134217728
          {% elif ansible_memtotal_mb >= 32768 %}
          4096 87380 67108864
          {% elif ansible_memtotal_mb >= 16384 %}
          4096 87380 33554432
          {% else %}
          4096 87380 16777216
          {% endif %}

      #
      # Max TCP receive buffer per socket (must match or exceed tcp_rmem max)
      # Dynamic scaling based on RAM
      #
      - name: net.core.rmem_max
        value: >-
          {% if ansible_memtotal_mb >= 65536 %}
          134217728
          {% elif ansible_memtotal_mb >= 32768 %}
          67108864
          {% elif ansible_memtotal_mb >= 16384 %}
          33554432
          {% else %}
          16777216
          {% endif %}

      #
      # TCP send buffer (min default max)
      # Dynamic scaling based on RAM for large email attachments and bulk operations
      # Conservative scaling to prevent excessive memory usage with many connections
      # https://fasterdata.es.net/host-tuning/linux/
      #
      - name: net.ipv4.tcp_wmem
        value: >-
          {% if ansible_memtotal_mb >= 65536 %}
          4096 16384 134217728
          {% elif ansible_memtotal_mb >= 32768 %}
          4096 65536 67108864
          {% elif ansible_memtotal_mb >= 16384 %}
          4096 65536 33554432
          {% else %}
          4096 65536 16777216
          {% endif %}

      #
      # Max TCP send buffer per socket (must match or exceed tcp_wmem max)
      # Dynamic scaling based on RAM
      #
      - name: net.core.wmem_max
        value: >-
          {% if ansible_memtotal_mb >= 65536 %}
          134217728
          {% elif ansible_memtotal_mb >= 32768 %}
          67108864
          {% elif ansible_memtotal_mb >= 16384 %}
          33554432
          {% else %}
          16777216
          {% endif %}

      # provide RFC 2861 behavior and time out congestion window after an idle period
      # many suggest to disable it to improve performance in some cases
      - name: net.ipv4.tcp_slow_start_after_idle
        value: 0

      # disable caching of TCP congestion state
      - name: net.ipv4.tcp_no_metrics_save
        value: 1

      # set number of retries for for TCP 3 way handshake (default is 5)
      # https://www.justsomestuff.co.uk/wiki/doku.php/linux/syn_tcp_timeout
      - name: net.ipv4.tcp_syn_retries
        value: 3

      #
      # number of times SYNACKS for passive TCP connection are tried
      # https://blog.cloudflare.com/syn-packet-handling-in-the-wild/
      #
      - name: net.ipv4.tcp_synack_retries
        value: 2

      #
      # TCP Fast Open (TFO) - DISABLED
      # While TFO can reduce latency by 15-41%, it is NOT yet supported in Node.js
      # libuv PR #1136 (2016) is still open and not merged as of 2025
      # Node.js issue #8066 (2016) is still open with no implementation
      # https://github.com/nodejs/node/issues/8066
      # https://github.com/libuv/libuv/pull/1136
      #
      # - name: net.ipv4.tcp_fastopen
      #   value: 3

      #
      # tune ICMP black holes and adjust path MTU in a smart way
      # https://blog.cloudflare.com/path-mtu-discovery-in-practice/
      #
      - name: net.ipv4.tcp_mtu_probing
        value: 1
      - name: net.ipv4.tcp_base_mss
        value: 1024

      #
      # make the system resistant to out of memory scenarios
      # https://www.linbit.com/kernel-min_free_kbytes/
      # https://dom.as/2016/05/13/linux-memory-management-for-servers/
      #
      # Dynamic calculation based on total RAM (1.56% of RAM):
      # - 64+ GB RAM: 1 GB (1048576 KB) - Facebook's recommendation for >100GB
      # - 32-63 GB RAM: 512 MB (524288 KB) - recommended for high-traffic servers
      # - 16-31 GB RAM: 256 MB (262144 KB) - recommended for email/database servers
      # - 8-15 GB RAM: 128 MB (131072 KB) - previous default
      # - <8 GB RAM: 64 MB (65536 KB) - legacy default
      #
      # Why this matters: kernel triggers background reclamation at 25% of this value.
      # With 64 MB, background reclaim starts at only 16 MB, causing direct reclaim
      # stalls (multi-second freezes) on 16-32 GB servers under memory pressure.
      #
      - name: vm.min_free_kbytes
        value: >-
          {% if ansible_memtotal_mb >= 65536 %}
          1048576
          {% elif ansible_memtotal_mb >= 32768 %}
          524288
          {% elif ansible_memtotal_mb >= 16384 %}
          262144
          {% elif ansible_memtotal_mb >= 8192 %}
          131072
          {% else %}
          65536
          {% endif %}

      # control syncookies
      - name: net.ipv4.tcp_syncookies
        value: 1

      # enable timestamps as defined in RFC1323
      - name: net.ipv4.tcp_timestamps
        value: 1

      #
      # Max orphaned TCP sockets (not attached to any user file handle)
      # Orphaned connections consume memory, so scale with available RAM
      # Formula: RAM_MB / 16 (conservative scaling)
      # If exceeded, orphaned connections are reset and warning printed
      #
      - name: net.ipv4.tcp_max_orphans
        value: >-
          {% if ansible_memtotal_mb >= 65536 %}
          4096000
          {% elif ansible_memtotal_mb >= 32768 %}
          2048000
          {% elif ansible_memtotal_mb >= 16384 %}
          1024000
          {% else %}
          262144
          {% endif %}

  roles:
    # https://github.com/Oefenweb/ansible-sysctl
    - role: sysctl

    # https://github.com/Oefenweb/ansible-dns
    - role: dns
      dns_nameservers:
        # cloudflare and google (ipv4/ipv6 and rotated)
        - 1.1.1.1
        - 2606:4700:4700::1111
        - 1.0.0.1
        - 2606:4700:4700::1001
        - 8.8.8.8
        - 2001:4860:4860::8888
        - 8.8.4.4
        - 2001:4860:4860::8844

    # https://github.com/Oefenweb/ansible-ntp
    - role: ntp
      ntp_servers:
        - time.cloudflare.com

    # https://github.com/Oefenweb/ansible-timezone
    #- role: timezone
    #  timezone_zone: 'XYZ'

    # https://github.com/Oefenweb/ansible-fail2ban
    - role: fail2ban
      fail2ban_maxretry: 2
      fail2ban_bantime: -1
      # dbpurgeage is ignored if bantime is -1 (?)
      fail2ban_dbpurgeage: 365d
      fail2ban_findtime: 365d
      # Email notifications for bans
      fail2ban_destemail: "{{ lookup('env', 'POSTFIX_RCPTS') | default('security@forwardemail.net') }}"
      fail2ban_sender: "{{ lookup('env', 'POSTFIX_USERNAME') | default('mailerdaemon@forwardemail.net') }}"
      fail2ban_action: "%(action_mwl)s"  # mail with logs
      fail2ban_mta: sendmail

      # TODO: add IMAP, POP3, and SMTP with pm2 error log output
      # https://www.teaparty.net/technotes/fail2ban.html#:~:text=I%20added%20the%20following%20to%20my%20jail.conf%3A

    # https://github.com/hifis-net/ansible-collection-toolkit (new)
    # https://github.com/jnv/ansible-role-unattended-upgrades (old)
    # - role: unattended-upgrades
    - role: hifis.toolkit.unattended_upgrades
      unattended_automatic_reboot_time: "02:00"
      # Email notifications for updates
      unattended_mail: "{{ lookup('env', 'POSTFIX_RCPTS') | default('security@forwardemail.net') }}"
      unattended_mail_sender: "{{ lookup('env', 'POSTFIX_USERNAME') | default('mailerdaemon@forwardemail.net') }}"
      unattended_mail_report: "on-change"  # Send email only when packages are upgraded or errors occur
      unattended_automatic_reboot: true
      unattended_automatic_reboot_with_users: false
