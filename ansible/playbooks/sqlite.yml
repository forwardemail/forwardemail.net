# Copyright (c) Forward Email LLC
# SPDX-License-Identifier: BUSL-1.1

---
- name: Import security playbook
  import_playbook: security.yml
- name: Import Node.js playbook
  import_playbook: node.yml
- name: Import SSH keys playbook
  import_playbook: ssh-keys.yml
- name: Import UFW allowlist playbook for SQLite
  import_playbook: ufw-allowlist.yml
  vars:
    target_hosts: sqlite
    service_name: SQLite
    service_port_var: SQLITE_PORT
    service_port_default: "3456"
    service_identifier: sqlite
    ufw_comment: "Auto-whitelist SQLite"

- name: Import high-traffic sysctl tuning for SQLite
  import_playbook: sysctl-high-traffic.yml
  vars:
    target_hosts: sqlite
    service_name: SQLite
    sysctl_file_name: sqlite

- name: Import I/O and filesystem tuning for SQLite
  import_playbook: io-filesystem-tuning.yml
  vars:
    target_hosts: sqlite
    service_name: SQLite
    service_identifier: sqlite
    data_directory: /home/deploy/sqlite
    read_ahead_kb: 16


- hosts: sqlite
  name: Hostname
  become: true
  become_user: root
  tasks:
    - name: Set hostname
      hostname:
        name: "{{ lookup('env', 'SQLITE_HOST') }}"

- hosts: sqlite
  name: SQLITE
  become: true
  become_user: root
  # this was already defined in the ufw role
  # https://github.com/Oefenweb/ansible-ufw/blob/master/handlers/main.yml
  handlers:
    - name: Reload UFW
      ufw:
        state: reloaded
  tasks:
    # UFW Configuration - Using reusable playbook
    # See ufw-allowlist.yml for implementation details
    #
    # modify ufw setup
    # https://github.com/Oefenweb/ansible-ufw/issues/21
    #
    - name: "Update ufw before.rules until #21 is resolved"
      template:
        src: "{{ playbook_dir }}/templates/before.rules.j2"
        dest: /etc/ufw/before.rules
        owner: root
        mode: "0644"
      notify: Reload UFW

    # SQLite-Specific Kernel Optimizations for WAL Mode
    - name: Configure SQLite-specific sysctl parameters for WAL mode
      ansible.builtin.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: true
        sysctl_file: /etc/sysctl.d/99-sqlite-wal.conf
      loop:
        # SQLite WAL mode benefits from these I/O optimizations
        - { name: 'vm.swappiness', value: '0' }  # Disable swapping for SQLite (override high-traffic default)
        - { name: 'vm.max_map_count', value: '262144' }  # Required for mmap() in WAL mode
        - { name: 'vm.vfs_cache_pressure', value: '50' }  # Prefer keeping inode/dentry cache for SQLite files
        - { name: 'vm.min_free_kbytes', value: '65536' }  # Reserve 64MB for emergency allocations
